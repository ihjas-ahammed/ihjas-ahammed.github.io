<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Electronics Journey</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom base styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Styles for step transitions */
        .step {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            position: absolute; /* Needed for clean transitions */
            width: 100%;
            left: 0;
            top: 0;
            padding: 1rem; /* Add padding within step */
            box-sizing: border-box;
        }

        .step.hidden {
            opacity: 0;
            transform: translateX(100%); /* Slide out to the right */
            pointer-events: none; /* Prevent interaction when hidden */
            height: 0; /* Collapse height when hidden */
            overflow: hidden;
            position: absolute; /* Keep it out of flow */
        }

         .step.prev-step {
             transform: translateX(-100%); /* Slide out to the left */
             position: absolute; /* Keep it out of flow */
        }

         .step.current-step {
            opacity: 1;
            transform: translateX(0);
            position: relative; /* Bring current step back into flow */
            height: auto; /* Allow height to adjust */
            overflow: visible;
        }

        /* Styling for code blocks and interactive elements */
        code {
            background-color: rgba(59, 59, 79, 0.8); /* input-bg with opacity */
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            color: #ffda63; /* Yellowish */
            font-size: 0.9em;
        }
        .interactive-section {
            background-color: rgba(10, 10, 35, 0.7);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px dashed #00ffff; /* accent */
        }
        .interactive-section label { display: block; margin-bottom: 5px; font-weight: bold; color: #00ffff; }
        .interactive-section input[type="text"],
        .interactive-section input[type="number"] {
            width: 100%; padding: 10px; margin-bottom: 10px; border: none;
            border-radius: 5px; background-color: #3b3b4f; /* input-bg */
            color: #f5f6f7; /* text-main */ font-size: 1em;
        }
        .interactive-section button {
             background-color: #00ffff; /* accent */ color: #0a0a23; /* primary */
             border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;
             font-size: 1em; font-weight: bold; margin-right: 10px; margin-bottom: 10px;
             transition: background-color 0.3s ease;
        }
        .interactive-section button:hover { background-color: #00e0e0; }
        .interactive-output {
            margin-top: 10px; padding: 10px; background-color: #0a0a23; /* primary */
            border-radius: 5px; font-family: 'Courier New', Courier, monospace;
            font-weight: bold; word-wrap: break-word; min-height: 30px;
            border: 1px solid #00ffff; /* accent */
        }
        .interactive-output .label { color: #00ffff; font-weight: normal; font-family: inherit; }
        .error-message { color: #ffcccb; font-size: 0.9em; margin-top: -5px; margin-bottom: 10px; }
        .signal-diagram {
            width: 90%; max-width: 250px; height: auto; display: block; margin: 15px auto;
            background: #fff; border-radius: 5px; padding: 10px; border: 1px solid #00ffff;
        }
        /* Table styles */
         table { width: 100%; border-collapse: collapse; margin-bottom: 15px; background-color: #1b1b32; font-size: 0.9em;}
         th, td { border: 1px solid #00ffff; padding: 6px; text-align: center; }
         th { background-color: #3b3b4f; color: #00ffff; }

        /* Quiz Option Styles */
        .option-btn.selected { background-color: #0891b2; color: white; font-weight: bold; }
        .option-btn.correct { background-color: #10b981 !important; color: white !important; border: 2px solid #059669; }
        .option-btn.incorrect { background-color: #f43f5e !important; color: white !important; border: 2px solid #e11d48; text-decoration: line-through; }
        .option-btn.highlight-correct { border: 2px solid #10b981; }

        /* Progress Dots */
        .progress-dots span { height: 8px; width: 8px; background-color: #6b7280; border-radius: 50%; display: inline-block; margin: 0 3px; transition: background-color 0.3s ease; }
        .progress-dots span.active { background-color: #00ffff; /* accent */ }
        .progress-dots span.completed { background-color: #10b981; /* emerald-500 */ }
        .progress-dots span.learning { background-color: #60a5fa; /* blue-400 */ } /* Different color for learning steps */
        .progress-dots span.quiz { background-color: #facc15; /* yellow-400 */ } /* Different color for quiz steps */


    </style>
    <script>
        tailwind.config = { /* No changes needed here */ }

        // --- Mock ReactNativeWebView (Remove in production) ---
        if (typeof window.ReactNativeWebView === 'undefined') {
            console.log("Mocking ReactNativeWebView for browser testing.");
            window.ReactNativeWebView = { postMessage: (message) => console.log("ReactNativeWebView.postMessage:", message) };
        }
        // --- End Mock ---
    </script>
</head>
<body class="bg-gradient-to-br from-primary to-secondary text-text-main min-h-screen flex items-center justify-center p-1">

    <div class="container bg-secondary/80 backdrop-blur-sm p-4 rounded-xl shadow-2xl w-full max-w-lg overflow-hidden min-h-[500px] relative flex flex-col">

        <h1 class="text-xl sm:text-2xl font-bold text-center mb-2 text-accent border-b border-accent/50 pb-2 flex-shrink-0">Digital Electronics Journey</h1>

        <!-- Progress Indicator -->
         <div id="progress-indicator" class="progress-dots text-center my-2 flex-shrink-0">
             <!-- Dots will be added here -->
         </div>

        <!-- Step Container - Takes remaining space -->
        <div id="step-container" class="relative flex-grow overflow-y-auto">
            <!-- Steps will be dynamically inserted here -->
            <!-- Note: overflow-y-auto allows scrolling within long steps -->
        </div>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons mt-3 text-center border-t border-accent/30 pt-3 flex-shrink-0">
            <button id="prev-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200 ease-in-out mr-2 hidden text-sm">Previous</button>
            <button id="next-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed text-sm">Start Journey</button>
        </div>

        <!-- Final Result Area (Initially Hidden) -->
         <div id="final-result" class="text-center mt-4 hidden flex-shrink-0">
            <p id="result-text" class="text-base font-semibold mb-3"></p>
            <button id="complete-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-5 rounded-lg shadow transition duration-200 ease-in-out text-sm">Finish Journey</button>
        </div>

    </div>

    <script>
        // --- Constants ---
        const NUM_QUIZ_QUESTIONS = 10;

        // --- Question Pool (40 Questions) ---
        const fullQuestionPool = [
            // Analog vs Digital
            { question: "Which signal type is less reliable due to infinite possible values?", options: ["Digital", "Binary", "Analog", "Square Wave"], answer: 2, summary: "Analog signals are susceptible to noise, which can alter their infinitely variable values, making them less reliable for precise operations compared to the two distinct states of digital signals." },
            { question: "A square wave is an example of which type of signal?", options: ["Analog", "Sinusoidal", "Digital", "Continuous"], answer: 2, summary: "Square waves have distinct high and low levels, representing the two states (1 and 0) of a digital or binary signal." },
            { question: "Driving a transistor between cut-off and saturation results in:", options: ["Amplification", "Two-state operation", "Linear output", "Oscillation"], answer: 1, summary: "In digital circuits, transistors act like switches, being either fully OFF (cut-off) or fully ON (saturation), representing the two binary states." },
            { question: "Why are digital circuits generally considered more reliable than analog circuits?", options: ["They are faster", "They use less power", "They handle discrete values", "They are cheaper"], answer: 2, summary: "Digital circuits operate with defined HIGH and LOW states, making them more immune to noise and variations compared to analog circuits processing continuous values." },
            { question: "A signal representing temperature that changes smoothly over time is:", options: ["Digital", "Binary", "Analog", "Encoded"], answer: 2, summary: "Physical quantities like temperature typically vary continuously, making their direct representation an analog signal." },
            // Binary Basics
            { question: "What is the term for a single binary digit (0 or 1)?", options: ["Byte", "Nibble", "Word", "Bit"], answer: 3, summary: "The fundamental unit of binary information is a 'bit'." },
            { question: "How many bits are in a nibble?", options: ["2", "4", "8", "16"], answer: 1, summary: "A nibble is defined as a group of 4 bits." },
            { question: "A byte consists of how many bits?", options: ["4", "8", "12", "16"], answer: 1, summary: "A standard byte is composed of 8 bits." },
            { question: "In the binary number 10110, which is the Most Significant Bit (MSB)?", options: ["The leftmost 1", "The rightmost 0", "The middle 1", "The 0 next to MSB"], answer: 0, summary: "The MSB is the bit with the highest place value, which is always the leftmost bit in standard notation." },
            { question: "What is the base or radix of the binary number system?", options: ["10", "8", "16", "2"], answer: 3, summary: "The binary system uses two digits (0 and 1), so its base (radix) is 2." },
            // Binary Counting & Conversions
            { question: "What is the binary representation of the decimal number 5?", options: ["100", "110", "101", "011"], answer: 2, summary: "Decimal 5 = (1 * 2^2) + (0 * 2^1) + (1 * 2^0) = 4 + 0 + 1 = 5. Binary is 101." },
            { question: "What is the decimal equivalent of the binary number 1101?", options: ["11", "13", "14", "9"], answer: 1, summary: "1101₂ = (1 * 2³) + (1 * 2²) + (0 * 2¹) + (1 * 2⁰) = 8 + 4 + 0 + 1 = 13₁₀." },
            { question: "Convert decimal 10 to binary.", options: ["1000", "1010", "1100", "1001"], answer: 1, summary: "Using double-dabble: 10/2=5 R 0; 5/2=2 R 1; 2/2=1 R 0; 1/2=0 R 1. Read remainders reverse: 1010₂." },
            { question: "What is the value of the binary number 0111 in decimal?", options: ["6", "7", "8", "15"], answer: 1, summary: "0111₂ = (0*8) + (1*4) + (1*2) + (1*1) = 4 + 2 + 1 = 7₁₀." },
            { question: "The binary number 10000 represents which decimal value?", options: ["8", "10", "16", "32"], answer: 2, summary: "10000₂ is 1 multiplied by 2 to the power of 4 (1 * 2⁴), which equals 16₁₀." },
             // Octal System
            { question: "What is the radix of the octal number system?", options: ["2", "16", "10", "8"], answer: 3, summary: "The octal system uses 8 digits (0-7), hence its base (radix) is 8." },
            { question: "Convert the octal number 23₈ to decimal.", options: ["19", "23", "11", "31"], answer: 0, summary: "23₈ = (2 * 8¹) + (3 * 8⁰) = 16 + 3 = 19₁₀." },
            { question: "What is the octal equivalent of the decimal number 10?", options: ["10", "12", "8", "A"], answer: 1, summary: "Divide by 8: 10 / 8 = 1 R 2. Read remainders reverse: 12₈." },
            { question: "How many binary bits are needed to represent one octal digit?", options: ["2", "3", "4", "8"], answer: 1, summary: "Since 2³ = 8, each octal digit (0-7) can be uniquely represented by a group of 3 binary bits (000-111)." },
            { question: "Convert the binary number 110 101₂ directly to octal.", options: ["65", "56", "35", "153"], answer: 0, summary: "Group binary digits in threes from right: 110 = 6, 101 = 5. Result: 65₈." },
             // Hexadecimal System
            { question: "Which base does the hexadecimal system use?", options: ["2", "8", "10", "16"], answer: 3, summary: "Hexadecimal is a base-16 system." },
            { question: "What decimal value does the hexadecimal digit 'C' represent?", options: ["10", "11", "12", "13"], answer: 2, summary: "In hexadecimal, A=10, B=11, C=12, D=13, E=14, F=15." },
            { question: "Convert the hexadecimal number 1A₁₆ to decimal.", options: ["10", "16", "26", "36"], answer: 2, summary: "1A₁₆ = (1 * 16¹) + (10 * 16⁰) = 16 + 10 = 26₁₀." },
            { question: "How many binary bits correspond to one hexadecimal digit?", options: ["2", "3", "4", "8"], answer: 2, summary: "Since 2⁴ = 16, each hexadecimal digit (0-F) can be represented by exactly 4 binary bits (0000-1111)." },
            { question: "Convert the binary number 1111 0010₂ directly to hexadecimal.", options: ["F2", "E2", "152", "2E"], answer: 0, summary: "Group binary digits in fours from right: 1111 = F, 0010 = 2. Result: F2₁₆." },
             // BCD Code
            { question: "What does BCD stand for?", options: ["Binary Coded Digit", "Binary Coded Decimal", "Base Coded Decimal", "Bit Coded Digit"], answer: 1, summary: "BCD stands for Binary Coded Decimal." },
            { question: "How is the decimal number 25 represented in BCD?", options: ["11001", "0010 0101", "100101", "19"], answer: 1, summary: "In BCD, each decimal digit is converted to its 4-bit binary equivalent: 2 -> 0010, 5 -> 0101. Result: 0010 0101." },
            { question: "What is the decimal value of the BCD code 1001 0110?", options: ["150", "96", "Invalid BCD", "1A6"], answer: 1, summary: "Convert each 4-bit group to its decimal digit: 1001 -> 9, 0110 -> 6. Result: 96₁₀." },
            { question: "Which 4-bit binary pattern is invalid in standard BCD?", options: ["1001", "0110", "1010", "0011"], answer: 2, summary: "BCD only represents decimal digits 0-9. 1010 represents decimal 10, which is not a single decimal digit, making it invalid in standard BCD." },
            { question: "Why is BCD used in some digital systems?", options: ["It's faster than binary", "It uses fewer bits", "Easy interface with decimal displays/inputs", "More efficient storage"], answer: 2, summary: "BCD makes it easier to convert to and from decimal representations, often used for displays (like 7-segment displays) and financial calculations." },
             // Inter-conversions & Mixed
            { question: "Convert (75)₈ to binary.", options: ["111101", "11101", "111 101", "101111"], answer: 2, summary: "Convert each octal digit to 3 bits: 7 -> 111, 5 -> 101. Combine them: 111 101₂." },
            { question: "Convert (3B)₁₆ to binary.", options: ["0011 1011", "111011", "1110110", "0111011"], answer: 0, summary: "Convert each hex digit to 4 bits: 3 -> 0011, B (11) -> 1011. Combine: 0011 1011₂." },
            { question: "What is the octal equivalent of (11010110)₂?", options: ["654", "326", "156", "D6"], answer: 1, summary: "Group binary in threes from right: (011)(010)(110). Convert groups: 011=3, 010=2, 110=6. Result: 326₈." },
            { question: "What is the hexadecimal equivalent of (101101110)₂?", options: ["556", "16E", "B70", "2DE"], answer: 1, summary: "Group binary in fours from right: (0001)(0110)(1110). Convert groups: 0001=1, 0110=6, 1110=E. Result: 16E₁₆." },
            { question: "Convert (52)₁₀ to hexadecimal.", options: ["34", "A4", "52", "2A"], answer: 0, summary: "Divide by 16: 52 / 16 = 3 R 4. Read remainders reverse: 34₁₆." },
            { question: "Which number system is most convenient for representing raw binary data in a more compact, human-readable form?", options: ["Decimal", "BCD", "Octal", "Hexadecimal"], answer: 3, summary: "Hexadecimal is widely used because it maps neatly to 4-bit binary groups (bytes are 8 bits), making long binary strings much shorter and easier to read/write." },
            { question: "Convert (401)₁₀ to BCD.", options: ["100 000 001", "0100 0000 0001", "110010001", "Invalid"], answer: 1, summary: "Convert each decimal digit: 4->0100, 0->0000, 1->0001. Result: 0100 0000 0001." },
            { question: "The number (1111 1010 0110)₂ is equivalent to which hexadecimal number?", options: ["F96", "EAG", "FA6", "7A6"], answer: 2, summary: "Group in fours: (1111)(1010)(0110). Convert: F A 6. Result: FA6₁₆." },
            { question: "Convert (27)₈ to hexadecimal.", options: ["17", "1F", "37", "1B"], answer: 3, summary: "Convert Oct->Bin->Hex: 27₈ = (010 111)₂. Regroup in fours: (0001 0111)₂ = 17₁₆. Error in options/prev calc: Correct is 17_16. Let's re-check 27_8 = 2*8+7 = 23_10. 23_10 = 16+7 = 17_16. Let's assume question meant 37_8 = 3*8+7 = 31_10 = 16+15 = 1F_16. If it was 17_8 = 1*8+7=15_10 = F_16. Let's assume the intended answer is 17_16 for 27_8. *Correction: Re-evaluating 27_8 = (010 111)₂ = (0001 0111)₂ = 17₁₆. Option 1 is correct based on calculation. Let's make a different question or fix options/answer.* Okay, let's change the question: Convert (63)₈ to hexadecimal." , options: ["33", "C3", "3F", "133"], answer: 2, summary: "Oct->Bin->Hex: 63₈ = (110 011)₂. Regroup in fours: (0011 0011)₂ = 33₁₆. *Another mismatch. Let's try again with a clean one:* Convert (75)₈ to hexadecimal." , options: ["3D", "75", "35", "F3"], answer: 0, summary: "Oct->Bin->Hex: 75₈ = (111 101)₂. Regroup: (0011 1101)₂ = 3D₁₆."},
            { question: "Represent (100)₁₀ in binary, octal, and hexadecimal.", options: ["1100100, 144, 64", "1100100, 64, 144", "1100010, 144, 64", "1100100, 144, 64"], answer: 0, summary: "100₁₀ = 64+32+4 = 1100100₂. Group for oct: (1)(100)(100) -> 144₈. Group for hex: (0110)(0100) -> 64₁₆." },
        ];

        // --- State Variables ---
        let currentStep = 0;
        let selectedQuizQuestions = [];
        let userAnswers = [];
        let quizCompleted = false;
        let totalJourneySteps = 0; // Will be calculated later

        // Fixed steps count (Intro + Learn x3 + Quiz Intro + Summary)
        const fixedStepsCount = 6;

        // --- DOM Elements ---
        const stepContainer = document.getElementById('step-container');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const finalResultDiv = document.getElementById('final-result');
        const resultText = document.getElementById('result-text');
        const completeBtn = document.getElementById('complete-btn');
        const progressIndicator = document.getElementById('progress-indicator');

        // --- Utility Functions (Include Helpers from previous example like displayOutput, isValidBinary etc.) ---
        function displayOutput(elementId, label, value, isError = false) { /* ... implementation ... */ }
        function displayError(elementId, message) { /* ... implementation ... */ }
        function clearError(elementId) { /* ... implementation ... */ }
        function isValidBinary(bin) { return /^[01]+$/.test(bin); }
        function isValidOctal(oct) { return /^[0-7]+$/.test(oct); }
        function isValidHex(hex) { return /^[0-9A-Fa-f]+$/.test(hex); }
        function isValidBcdInput(bcdStr) { /* ... implementation ... */ }
        // --- (Paste the full helper functions here from the first provided example) ---
                function displayOutput(elementId, label, value, isError = false) {
            const outputElement = document.getElementById(elementId);
            if (outputElement) {
                let content = `<span class="label">${label}:</span> `;
                if (isError) {
                    content += `<span class="text-red-300">${value}</span>`; // Use Tailwind color
                } else {
                    content += value; // Value might contain HTML (like <br> or <sub>)
                }
                 outputElement.innerHTML = content;
            }
        }
        function displayError(elementId, message) {
            const errorElement = document.getElementById(elementId);
             if (errorElement) {
                 errorElement.textContent = message;
                 errorElement.classList.remove('hidden'); // Show error message
             }
        }
        function clearError(elementId) {
             const errorElement = document.getElementById(elementId);
             if (errorElement) {
                 errorElement.textContent = '';
                  errorElement.classList.add('hidden'); // Hide error message
             }
        }
        // isValidBinary, isValidOctal, isValidHex remain the same
         function isValidBcdInput(bcdStr) {
            const groups = bcdStr.trim().split(/\s+/);
            if (groups.length === 0 || groups[0] === '') return false;
            for (const group of groups) {
                if (!/^[01]{4}$/.test(group)) return false;
                 // Stricter check for valid BCD digits (0000-1001)
                 if (parseInt(group, 2) > 9) return false;
            }
            return true;
        }
        // hexToBinMap, binToHexMap, decToBcdMap, bcdToDecMap remain the same
        const hexToBinMap = { '0': '0000', '1': '0001', '2': '0010', '3': '0011', '4': '0100', '5': '0101', '6': '0110', '7': '0111', '8': '1000', '9': '1001', 'A': '1010', 'B': '1011', 'C': '1100', 'D': '1101', 'E': '1110', 'F': '1111' };
        const binToHexMap = { '0000': '0', '0001': '1', '0010': '2', '0011': '3', '0100': '4', '0101': '5', '0110': '6', '0111': '7', '1000': '8', '1001': '9', '1010': 'A', '1011': 'B', '1100': 'C', '1101': 'D', '1110': 'E', '1111': 'F' };
        const decToBcdMap = { '0': '0000', '1': '0001', '2': '0010', '3': '0011', '4': '0100', '5': '0101', '6': '0110', '7': '0111', '8': '1000', '9': '1001' };
        const bcdToDecMap = { '0000':'0', '0001':'1', '0010':'2', '0011':'3', '0100':'4', '0101':'5', '0110':'6', '0111':'7', '1000':'8', '1001':'9' };
        // --- Interactive Conversion Functions ---
        function showPlaceValue() {
            const binInput = document.getElementById('binPlaceValueInput').value.trim();
            const outputElement = document.getElementById('binPlaceValueOutput');
            clearError('binPlaceValueError'); // Assuming error element exists with this ID

            if (!binInput) { outputElement.textContent = ''; return; }
            if (!isValidBinary(binInput)) {
                 displayError('binPlaceValueError', 'Invalid binary input.');
                 outputElement.textContent = ''; return;
             }

            let explanation = ''; let decimalValue = 0; const len = binInput.length;
            explanation += `<code>${binInput}</code><sub class="text-xs">2</sub> = `;
            let terms = [];
            for (let i = 0; i < len; i++) {
                const bit = parseInt(binInput[i]); const power = len - 1 - i;
                const placeValue = Math.pow(2, power); decimalValue += bit * placeValue;
                terms.push(`(${bit} × 2<sup>${power}</sup>)`);
            }
            explanation += terms.join(' + ');
            explanation += `<br>= ${decimalValue}<sub class="text-xs">10</sub>`;
            outputElement.innerHTML = explanation;
        }
        // Add ALL other conversion functions (convertToBinary, convertToDecimal, convertToOctal, etc.) here...
                // --- Interactive Functions (Copied and adapted) ---
        function convertToBinary() {
            const decInput = document.getElementById('decToBinInput').value;
            const outputId = 'decToBinOutput';
            const errorId = 'decToBinError'; // Assume an error div exists
            clearError(errorId);
            if (decInput === '' || isNaN(decInput) || decInput < 0 || !Number.isInteger(Number(decInput))) {
                displayError(errorId, 'Please enter a non-negative integer.');
                 displayOutput(outputId, 'Binary', '', true); return;
            }
            const decimal = parseInt(decInput, 10); const binary = decimal.toString(2);
             displayOutput(outputId, 'Binary', `<code>${binary}</code><sub class="text-xs">2</sub>`);
        }
        function convertToDecimal() {
            const binInput = document.getElementById('binToDecInput').value.trim();
            const outputId = 'binToDecOutput'; const errorId = 'binToDecError'; clearError(errorId);
            if (!binInput) { displayOutput(outputId, 'Decimal', ''); return; }
            if (!isValidBinary(binInput)) {
                displayError(errorId, 'Invalid binary input (only 0s and 1s).');
                displayOutput(outputId, 'Decimal', '', true); return;
            }
            const decimal = parseInt(binInput, 2);
            displayOutput(outputId, 'Decimal', `${decimal}<sub class="text-xs">10</sub>`);
        }
        function convertToOctal() {
            const decInput = document.getElementById('decToOctInput').value;
            const outputId = 'decToOctOutput'; const errorId = 'decToOctError'; clearError(errorId);
            if (decInput === '' || isNaN(decInput) || decInput < 0 || !Number.isInteger(Number(decInput))) {
                 displayError(errorId, 'Please enter a non-negative integer.');
                 displayOutput(outputId, 'Octal', '', true); return;
            }
            const decimal = parseInt(decInput, 10); const octal = decimal.toString(8);
            displayOutput(outputId, 'Octal', `<code>${octal}</code><sub class="text-xs">8</sub>`);
        }
        function convertOctToDecimal() {
             const octInput = document.getElementById('octToDecInput').value.trim();
             const outputId = 'octToDecOutput'; const errorId = 'octToDecError'; clearError(errorId);
             if (!octInput) { displayOutput(outputId, 'Decimal', ''); return; }
             if (!isValidOctal(octInput)) {
                 displayError(errorId, 'Invalid octal input (only digits 0-7).');
                 displayOutput(outputId, 'Decimal', '', true); return;
             }
            const decimal = parseInt(octInput, 8);
            displayOutput(outputId, 'Decimal', `${decimal}<sub class="text-xs">10</sub>`);
        }
        function convertOctToBinary() {
             const octInput = document.getElementById('octToBinInput').value.trim();
             const outputId = 'octToBinOutput'; const errorId = 'octToBinError'; clearError(errorId);
             if (!octInput) { displayOutput(outputId, 'Binary', ''); return; }
             if (!isValidOctal(octInput)) {
                 displayError(errorId, 'Invalid octal input (only digits 0-7).');
                 displayOutput(outputId, 'Binary', '', true); return;
             }
             let binary = '';
             for (let i = 0; i < octInput.length; i++) {
                binary += parseInt(octInput[i], 8).toString(2).padStart(3, '0') + ' ';
             }
            displayOutput(outputId, 'Binary', `<code>${binary.trim()}</code><sub class="text-xs">2</sub>`);
        }
         function convertBinToOctal() {
            let binInput = document.getElementById('binToOctInput').value.trim().replace(/\s+/g, '');
             const outputId = 'binToOctOutput'; const errorId = 'binToOctError'; clearError(errorId);
             if (!binInput) { displayOutput(outputId, 'Octal', ''); return; }
             if (!isValidBinary(binInput)) {
                 displayError(errorId, 'Invalid binary input.');
                 displayOutput(outputId, 'Octal', '', true); return;
             }
             const remainder = binInput.length % 3; if (remainder !== 0) binInput = '0'.repeat(3 - remainder) + binInput;
             let octal = '';
             for (let i = 0; i < binInput.length; i += 3) { octal += parseInt(binInput.substring(i, i + 3), 2).toString(8); }
             displayOutput(outputId, 'Octal', `<code>${octal}</code><sub class="text-xs">8</sub>`);
         }
        function convertToHex() {
            const decInput = document.getElementById('decToHexInput').value;
            const outputId = 'decToHexOutput'; const errorId = 'decToHexError'; clearError(errorId);
             if (decInput === '' || isNaN(decInput) || decInput < 0 || !Number.isInteger(Number(decInput))) {
                 displayError(errorId, 'Please enter a non-negative integer.');
                 displayOutput(outputId, 'Hex', '', true); return;
             }
            const decimal = parseInt(decInput, 10); const hex = decimal.toString(16).toUpperCase();
            displayOutput(outputId, 'Hex', `<code>${hex}</code><sub class="text-xs">16</sub>`);
        }
        function convertHexToDecimal() {
             const hexInput = document.getElementById('hexToDecInput').value.trim();
             const outputId = 'hexToDecOutput'; const errorId = 'hexToDecError'; clearError(errorId);
              if (!hexInput) { displayOutput(outputId, 'Decimal', ''); return; }
             if (!isValidHex(hexInput)) {
                 displayError(errorId, 'Invalid hex input (0-9, A-F).');
                 displayOutput(outputId, 'Decimal', '', true); return;
             }
            const decimal = parseInt(hexInput, 16);
            displayOutput(outputId, 'Decimal', `${decimal}<sub class="text-xs">10</sub>`);
        }
        function convertHexToBinary() {
            const hexInput = document.getElementById('hexToBinInput').value.trim().toUpperCase();
             const outputId = 'hexToBinOutput'; const errorId = 'hexToBinError'; clearError(errorId);
             if (!hexInput) { displayOutput(outputId, 'Binary', ''); return; }
             if (!isValidHex(hexInput)) {
                 displayError(errorId, 'Invalid hex input (0-9, A-F).');
                 displayOutput(outputId, 'Binary', '', true); return;
             }
             let binary = '';
             for (let i = 0; i < hexInput.length; i++) { binary += hexToBinMap[hexInput[i]] + ' '; }
            displayOutput(outputId, 'Binary', `<code>${binary.trim()}</code><sub class="text-xs">2</sub>`);
        }
         function convertBinToHex() {
            let binInput = document.getElementById('binToHexInput').value.trim().replace(/\s+/g, '');
             const outputId = 'binToHexOutput'; const errorId = 'binToHexError'; clearError(errorId);
             if (!binInput) { displayOutput(outputId, 'Hex', ''); return; }
             if (!isValidBinary(binInput)) {
                 displayError(errorId, 'Invalid binary input.');
                 displayOutput(outputId, 'Hex', '', true); return;
             }
             const remainder = binInput.length % 4; if (remainder !== 0) binInput = '0'.repeat(4 - remainder) + binInput;
             let hex = '';
             for (let i = 0; i < binInput.length; i += 4) { hex += binToHexMap[binInput.substring(i, i + 4)]; }
             displayOutput(outputId, 'Hex', `<code>${hex}</code><sub class="text-xs">16</sub>`);
         }
        function convertToBcd() {
            const decInput = document.getElementById('decToBcdInput').value;
            const outputId = 'decToBcdOutput'; const errorId = 'decToBcdError'; clearError(errorId);
             if (decInput === '' || isNaN(decInput) || decInput < 0 || !Number.isInteger(Number(decInput))) {
                 displayError(errorId, 'Please enter a non-negative integer.');
                 displayOutput(outputId, 'BCD', '', true); return;
             }
            let bcd = ''; const decString = decInput.toString();
            for (let i = 0; i < decString.length; i++) { bcd += decToBcdMap[decString[i]] + ' '; }
            displayOutput(outputId, 'BCD', `<code>${bcd.trim()}</code>`);
        }
        function convertBcdToDecimal() {
            const bcdInput = document.getElementById('bcdToDecInput').value.trim();
            const outputId = 'bcdToDecOutput'; const errorId = 'bcdToDecError'; clearError(errorId);
             if (!bcdInput) { displayOutput(outputId, 'Decimal', ''); return; }
             // Validate BCD format (space separated 4-bit groups 0000-1001)
             if (!isValidBcdInput(bcdInput)) {
                  displayError(errorId, 'Invalid BCD format/value. Use 4-bit groups (0000-1001) separated by spaces.');
                  displayOutput(outputId, 'Decimal', '', true); return;
             }
             const groups = bcdInput.split(/\s+/); let decimal = '';
             for (const group of groups) { decimal += bcdToDecMap[group]; }
             displayOutput(outputId, 'Decimal', `${decimal}<sub class="text-xs">10</sub>`);
        }

        // --- Journey Logic ---
        function shuffleArray(array) { // Fisher-Yates Shuffle
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function selectRandomQuestions() {
            selectedQuizQuestions = shuffleArray([...fullQuestionPool]).slice(0, NUM_QUIZ_QUESTIONS);
            userAnswers = new Array(NUM_QUIZ_QUESTIONS).fill(undefined);
            totalJourneySteps = fixedStepsCount + NUM_QUIZ_QUESTIONS; // Recalculate total steps
            quizCompleted = false; // Reset quiz state
        }

        function renderProgressDots() {
            progressIndicator.innerHTML = '';
            for (let i = 0; i < totalJourneySteps; i++) {
                 const dot = document.createElement('span');
                 let stepType = ''; // To apply different colors

                 if (i === 0) stepType = 'intro';
                 else if (i >= 1 && i <= 3) stepType = 'learning'; // Learning steps
                 else if (i === 4) stepType = 'quiz-intro';
                 else if (i > 4 && i <= 4 + NUM_QUIZ_QUESTIONS) stepType = 'quiz'; // Quiz steps
                 else stepType = 'summary';

                 if (i === currentStep) {
                     dot.classList.add('active');
                 } else if (i < currentStep || (quizCompleted && i < totalJourneySteps - 1) ) {
                      dot.classList.add('completed');
                 }

                 // Add type class for specific styling
                 if (stepType === 'learning') dot.classList.add('learning');
                 else if (stepType === 'quiz') dot.classList.add('quiz');

                 progressIndicator.appendChild(dot);
            }
        }

        function renderStep(stepIndex) {
            // Remove previous step classes
            stepContainer.querySelectorAll('.step').forEach(step => {
                 step.classList.remove('current-step', 'prev-step');
                 step.classList.add('hidden');
            });

            let currentStepElement = stepContainer.querySelector(`#step-${stepIndex}`);
            const isNewStep = !currentStepElement;

            if (isNewStep) {
                currentStepElement = document.createElement('div');
                currentStepElement.id = `step-${stepIndex}`;
                currentStepElement.classList.add('step');
                let stepContent = '';

                // --- Define Content for Each Step ---
                switch (stepIndex) {
                    case 0: // Intro
                        stepContent = `
                            <div class="text-center">
                                <h2 class="text-xl font-semibold mb-3 text-cyan-400">Welcome!</h2>
                                <p class="mb-2">This journey covers the fundamentals of Digital Electronics.</p>
                                <p class="mb-4">You'll review key concepts and then test your knowledge with a ${NUM_QUIZ_QUESTIONS}-question quiz randomly selected from a larger pool.</p>
                                <p class="text-sm text-gray-400">Use the 'Next' button to proceed through learning modules and the quiz.</p>
                            </div>`;
                        break;
                    case 1: // Analog vs Binary
                         stepContent = `
                            <h2 class="text-lg font-semibold mb-3 text-cyan-400">1. Analog vs. Binary Signals</h2>
                            <h3 class="font-medium mb-2 text-cyan-300">Analog Signal</h3>
                            <ul class="list-disc ml-6 mb-3 text-sm space-y-1">
                                <li>Continuously varying signal.</li>
                                <li>Can take any value within a range.</li>
                                <li>Example: Alternating voltage varying sinusoidally.</li>
                            </ul>
                            <svg viewBox="0 0 100 50" class="signal-diagram" aria-label="Sine wave diagram">
                              <path d="M 0 25 Q 12.5 0, 25 25 T 50 25 T 75 25 T 100 25" stroke="#00ffff" fill="transparent" stroke-width="1.5"/>
                              <line x1="0" y1="25" x2="100" y2="25" stroke="gray" stroke-dasharray="2,2"/>
                            </svg>
                            <p class="text-sm mb-3">Transistors processing analog signals produce continuously varying outputs. Less reliable due to noise sensitivity.</p>

                            <h3 class="font-medium mb-2 text-cyan-300">Binary Signal</h3>
                             <ul class="list-disc ml-6 mb-3 text-sm space-y-1">
                                <li>Has only two discrete, distinct values (High/Low, On/Off, 1/0).</li>
                                <li>Example: A square wave.</li>
                            </ul>
                             <svg viewBox="0 0 100 50" class="signal-diagram" aria-label="Square wave diagram">
                               <polyline points="0,40 20,40 20,10 40,10 40,40 60,40 60,10 80,10 80,40 100,40" stroke="#00ffff" fill="transparent" stroke-width="1.5"/>
                               <text x="5" y="38" font-size="7px" fill="gray">Low (0)</text> <text x="25" y="8" font-size="7px" fill="gray">High (1)</text>
                            </svg>
                            <p class="text-sm mb-3">Digital signals drive transistors fully ON (saturation) or OFF (cut-off), enabling stable two-state operation.</p>

                            <h3 class="font-medium mb-2 text-cyan-300">Digital Circuit</h3>
                            <p class="text-sm mb-3">Electronic circuits designed specifically to process these two-state binary signals.</p>
                        `;
                        break;
                    case 2: // Binary System
                        stepContent = `
                            <h2 class="text-lg font-semibold mb-3 text-cyan-400">2. The Binary System</h2>
                            <p class="text-sm mb-3">Uses only two digits: <code>0</code> and <code>1</code>. Radix (base) = 2.</p>
                            <h3 class="font-medium mb-2 text-cyan-300">Counting</h3>
                            <!-- Simple counting table -->
                            <table><thead><tr><th>Dec</th><th>Bin</th></tr></thead>
                            <tbody><tr><td>0</td><td>0</td></tr><tr><td>1</td><td>1</td></tr><tr><td>2</td><td>10</td></tr><tr><td>3</td><td>11</td></tr><tr><td>4</td><td>100</td></tr></tbody></table>

                            <h3 class="font-medium mb-2 text-cyan-300">Terminology</h3>
                            <ul class="list-disc ml-6 mb-3 text-sm space-y-1">
                                <li><strong>Bit:</strong> A single binary digit (0 or 1).</li>
                                <li><strong>Nibble:</strong> A group of 4 bits.</li>
                                <li><strong>Byte:</strong> A group of 8 bits.</li>
                            </ul>

                            <h3 class="font-medium mb-2 text-cyan-300">Place Value</h3>
                            <p class="text-sm mb-2">Each position represents a power of 2.</p>
                            <p class="text-xs mb-1">Example: <code>1011</code><sub class="text-xs">2</sub> = (1 × 2<sup>3</sup>) + (0 × 2<sup>2</sup>) + (1 × 2<sup>1</sup>) + (1 × 2<sup>0</sup>)</p>
                            <p class="text-xs mb-3">= 8 + 0 + 2 + 1 = 11<sub class="text-xs">10</sub></p>
                            <ul class="list-disc ml-6 mb-3 text-xs space-y-1">
                                <li>MSB: Most Significant Bit (leftmost, highest value).</li>
                                <li>LSB: Least Significant Bit (rightmost, lowest value).</li>
                            </ul>

                             <div class="interactive-section">
                                <h4 class="text-base font-medium mb-2 text-cyan-300">Explore Place Value</h4>
                                <label for="binPlaceValueInput">Enter Binary:</label>
                                <input type="text" id="binPlaceValueInput" placeholder="e.g., 1101" class="text-sm">
                                <div id="binPlaceValueError" class="error-message hidden"></div>
                                <button onclick="showPlaceValue()" class="text-sm">Show Calculation</button>
                                <div id="binPlaceValueOutput" class="interactive-output text-sm"></div>
                             </div>
                        `;
                         break;
                    case 3: // Conversions (Oct, Hex, BCD)
                         stepContent = `
                             <h2 class="text-lg font-semibold mb-3 text-cyan-400">3. Number Systems & Conversions</h2>

                             <!-- Octal -->
                             <h3 class="font-medium mb-2 text-cyan-300">Octal (Base 8)</h3>
                             <p class="text-sm mb-2">Uses digits 0-7. Easily convertible to/from binary (3 bits per octal digit).</p>
                             <div class="interactive-section mb-4">
                                <h4 class="text-base font-medium mb-2 text-cyan-300">Octal Tools</h4>
                                <!-- Dec <-> Oct -->
                                <label for="decToOctInput">Dec to Oct:</label> <input type="number" id="decToOctInput" placeholder="Decimal" class="text-sm">
                                <div id="decToOctError" class="error-message hidden"></div> <button onclick="convertToOctal()" class="text-xs">Convert</button>
                                <div id="decToOctOutput" class="interactive-output text-sm mb-2"></div>
                                <label for="octToDecInput">Oct to Dec:</label> <input type="text" id="octToDecInput" placeholder="Octal (0-7)" class="text-sm">
                                <div id="octToDecError" class="error-message hidden"></div> <button onclick="convertOctToDecimal()" class="text-xs">Convert</button>
                                <div id="octToDecOutput" class="interactive-output text-sm mb-2"></div>
                                 <!-- Oct <-> Bin -->
                                <label for="octToBinInput">Oct to Bin:</label> <input type="text" id="octToBinInput" placeholder="Octal (0-7)" class="text-sm">
                                <div id="octToBinError" class="error-message hidden"></div> <button onclick="convertOctToBinary()" class="text-xs">Convert</button>
                                <div id="octToBinOutput" class="interactive-output text-sm mb-2"></div>
                                <label for="binToOctInput">Bin to Oct:</label> <input type="text" id="binToOctInput" placeholder="Binary (group by 3)" class="text-sm">
                                <div id="binToOctError" class="error-message hidden"></div> <button onclick="convertBinToOctal()" class="text-xs">Convert</button>
                                <div id="binToOctOutput" class="interactive-output text-sm"></div>
                             </div>

                             <!-- Hexadecimal -->
                             <h3 class="font-medium mb-2 text-cyan-300">Hexadecimal (Base 16)</h3>
                             <p class="text-sm mb-2">Uses 0-9 and A-F (A=10...F=15). Maps to 4 binary bits.</p>
                             <!-- Hex Table Snippet -->
                             <table class="mb-3"><thead><tr><th>Dec</th><th>Hex</th><th>Bin</th></tr></thead><tbody><tr><td>10</td><td>A</td><td>1010</td></tr><tr><td>...</td><td>...</td><td>...</td></tr><tr><td>15</td><td>F</td><td>1111</td></tr></tbody></table>
                              <div class="interactive-section mb-4">
                                 <h4 class="text-base font-medium mb-2 text-cyan-300">Hexadecimal Tools</h4>
                                 <!-- Add Dec<->Hex, Hex<->Bin converter inputs/buttons/outputs here -->
                                 <label for="decToHexInput">Dec to Hex:</label> <input type="number" id="decToHexInput" placeholder="Decimal" class="text-sm">
                                 <div id="decToHexError" class="error-message hidden"></div> <button onclick="convertToHex()" class="text-xs">Convert</button>
                                 <div id="decToHexOutput" class="interactive-output text-sm mb-2"></div>
                                 <label for="hexToDecInput">Hex to Dec:</label> <input type="text" id="hexToDecInput" placeholder="Hex (0-9, A-F)" class="text-sm">
                                 <div id="hexToDecError" class="error-message hidden"></div> <button onclick="convertHexToDecimal()" class="text-xs">Convert</button>
                                 <div id="hexToDecOutput" class="interactive-output text-sm mb-2"></div>
                                 <label for="hexToBinInput">Hex to Bin:</label> <input type="text" id="hexToBinInput" placeholder="Hex (0-9, A-F)" class="text-sm">
                                 <div id="hexToBinError" class="error-message hidden"></div> <button onclick="convertHexToBinary()" class="text-xs">Convert</button>
                                 <div id="hexToBinOutput" class="interactive-output text-sm mb-2"></div>
                                 <label for="binToHexInput">Bin to Hex:</label> <input type="text" id="binToHexInput" placeholder="Binary (group by 4)" class="text-sm">
                                 <div id="binToHexError" class="error-message hidden"></div> <button onclick="convertBinToHex()" class="text-xs">Convert</button>
                                 <div id="binToHexOutput" class="interactive-output text-sm"></div>
                              </div>

                             <!-- BCD -->
                             <h3 class="font-medium mb-2 text-cyan-300">Binary Coded Decimal (BCD)</h3>
                             <p class="text-sm mb-2">Represents each decimal digit (0-9) with its 4-bit binary equivalent. Useful for decimal interfacing.</p>
                             <p class="text-xs mb-2">Example: <code>289</code><sub class="text-xs">10</sub> = <code>0010 1000 1001</code> (BCD)</p>
                             <div class="interactive-section">
                                 <h4 class="text-base font-medium mb-2 text-cyan-300">BCD Tools</h4>
                                 <!-- Add Dec<->BCD converter inputs/buttons/outputs here -->
                                 <label for="decToBcdInput">Dec to BCD:</label> <input type="number" id="decToBcdInput" placeholder="Decimal (0-9 digits)" class="text-sm">
                                 <div id="decToBcdError" class="error-message hidden"></div> <button onclick="convertToBcd()" class="text-xs">Convert</button>
                                 <div id="decToBcdOutput" class="interactive-output text-sm mb-2"></div>
                                 <label for="bcdToDecInput">BCD to Dec:</label> <input type="text" id="bcdToDecInput" placeholder="BCD (space separated 4-bit groups)" class="text-sm">
                                 <div id="bcdToDecError" class="error-message hidden"></div> <button onclick="convertBcdToDecimal()" class="text-xs">Convert</button>
                                 <div id="bcdToDecOutput" class="interactive-output text-sm"></div>
                             </div>
                         `;
                         break;
                    case 4: // Quiz Intro
                        stepContent = `
                            <div class="text-center">
                                <h2 class="text-xl font-semibold mb-3 text-cyan-400">Quiz Time!</h2>
                                <p class="mb-4">Let's test your understanding. You will be presented with ${NUM_QUIZ_QUESTIONS} randomly selected questions.</p>
                                <p class="text-sm text-gray-400">Select the best answer for each question and click 'Next'.</p>
                            </div>`;
                        break;
                    // Cases for Quiz Questions (Dynamically generated)
                    // Case for Summary (Dynamically generated)

                    default: // Should handle quiz questions and summary
                         if (stepIndex > 4 && stepIndex <= 4 + NUM_QUIZ_QUESTIONS) { // Quiz Question Step
                            const qIndex = stepIndex - (4 + 1); // Index within selectedQuizQuestions (0-based)
                            if (qIndex < selectedQuizQuestions.length) {
                                const q = selectedQuizQuestions[qIndex];
                                let optionsHTML = '';
                                q.options.forEach((opt, optIndex) => {
                                    const isSelected = userAnswers[qIndex] === optIndex;
                                    optionsHTML += `
                                        <div class="option-btn bg-input-bg hover:bg-cyan-800/50 p-3 my-2 rounded-lg cursor-pointer transition duration-150 ease-in-out text-sm ${isSelected ? 'selected' : ''}"
                                             data-q-index="${qIndex}" data-opt-index="${optIndex}">
                                            ${opt}
                                        </div>
                                    `;
                                });
                                stepContent = `
                                    <div class="question-block p-1">
                                        <div class="question text-base font-medium mb-4">Q ${qIndex + 1}/${NUM_QUIZ_QUESTIONS}: ${q.question}</div>
                                        <div class="options">${optionsHTML}</div>
                                    </div>
                                `;
                            } else { stepContent = `<p>Error: Question index out of bounds.</p>`; }

                        } else if (stepIndex === totalJourneySteps - 1) { // Summary Step
                             stepContent = renderSummary();
                        } else {
                             stepContent = `<p>Step ${stepIndex} content not defined.</p>`;
                        }
                        break;
                }

                currentStepElement.innerHTML = stepContent;
                stepContainer.appendChild(currentStepElement);

                // Add event listeners if it's a quiz question step or contains interactive elements
                if (stepIndex > 4 && stepIndex <= 4 + NUM_QUIZ_QUESTIONS) {
                    currentStepElement.querySelectorAll('.option-btn').forEach(btn => {
                        btn.addEventListener('click', handleOptionClick);
                    });
                }
                 // If step 3 (conversions), attach listeners to buttons (better done via delegation later if performance is an issue)
                 if (stepIndex === 3 || stepIndex === 2) { // Also handles place value in step 2
                     // The functions are global, just need to ensure elements exist
                 }

            } // end if(isNewStep)


             // Manage visibility and transitions (same logic as before)
            const previousStepIndex = parseInt(stepContainer.dataset.previousStep || '-1');
             if (stepIndex > previousStepIndex) {
                 const prevStepElement = stepContainer.querySelector(`#step-${previousStepIndex}`);
                 if (prevStepElement) prevStepElement.classList.add('prev-step');
                 currentStepElement.classList.remove('hidden', 'prev-step');
                 currentStepElement.classList.add('current-step');
             } else {
                 const prevStepElement = stepContainer.querySelector(`#step-${previousStepIndex}`);
                 if (prevStepElement) prevStepElement.classList.remove('prev-step');
                 currentStepElement.style.transform = 'translateX(-100%)';
                 requestAnimationFrame(() => {
                    currentStepElement.classList.remove('hidden', 'prev-step');
                    currentStepElement.classList.add('current-step');
                 });
             }

            stepContainer.dataset.previousStep = stepIndex;
            stepContainer.scrollTop = 0; // Scroll to top of new step

            updateButtonStates();
            renderProgressDots();
        }


        function updateButtonStates() {
            prevBtn.classList.toggle('hidden', currentStep === 0);
            nextBtn.classList.remove('hidden');
            finalResultDiv.classList.add('hidden');

            if (currentStep === 0) { nextBtn.textContent = 'Start Journey'; nextBtn.disabled = false; }
            else if (currentStep < 4) { nextBtn.textContent = 'Next Module'; nextBtn.disabled = false; } // Learning steps
            else if (currentStep === 4) { nextBtn.textContent = 'Start Quiz'; nextBtn.disabled = false; } // Quiz intro
            else if (currentStep > 4 && currentStep <= 4 + NUM_QUIZ_QUESTIONS) { // Quiz questions
                const qIndex = currentStep - (4 + 1);
                nextBtn.disabled = userAnswers[qIndex] === undefined; // Disable until answered
                 if (currentStep === 4 + NUM_QUIZ_QUESTIONS) { nextBtn.textContent = 'View Summary'; }
                 else { nextBtn.textContent = 'Next Question'; }
            } else if (currentStep === totalJourneySteps - 1) { // Summary step
                nextBtn.classList.add('hidden');
                prevBtn.classList.remove('hidden'); // Allow back from summary
                finalResultDiv.classList.remove('hidden');
                calculateAndDisplayResults(); // Calculate score now
            }
        }

        function handleOptionClick(event) { /* ... (same as before) ... */
            if (quizCompleted) return;
            const selectedBtn = event.target.closest('.option-btn');
            const qIndex = parseInt(selectedBtn.dataset.qIndex);
            const optIndex = parseInt(selectedBtn.dataset.optIndex);
            userAnswers[qIndex] = optIndex;
            const optionsInQuestion = stepContainer.querySelectorAll(`.option-btn[data-q-index="${qIndex}"]`);
            optionsInQuestion.forEach(btn => btn.classList.remove('selected'));
            selectedBtn.classList.add('selected');
            nextBtn.disabled = false; // Enable Next button
         }

        function nextStep() {
            if (currentStep === 4) { // Moving from Quiz Intro to first question
                selectRandomQuestions(); // Select questions NOW
                // Need to re-render immediately to update total steps/dots before moving
                renderProgressDots();
            }
             if (currentStep < totalJourneySteps - 1) {
                 if (currentStep === 4 + NUM_QUIZ_QUESTIONS) { // Moving to summary
                      quizCompleted = true;
                 }
                currentStep++;
                renderStep(currentStep);
            }
        }

        function prevStep() { /* ... (same as before) ... */
             if (currentStep > 0) {
                currentStep--;
                renderStep(currentStep);
            }
        }

        function calculateAndDisplayResults() { /* ... (same as before - uses selectedQuizQuestions.length) ... */
             let score = 0;
             userAnswers.forEach((answer, index) => {
                 if (selectedQuizQuestions[index] && answer === selectedQuizQuestions[index].answer) {
                     score++;
                 }
             });
             const accuracy = selectedQuizQuestions.length > 0 ? score / selectedQuizQuestions.length : 0;
             resultText.textContent = `Quiz Complete! You scored ${score} out of ${selectedQuizQuestions.length}. (${(accuracy * 100).toFixed(0)}%)`;
             try {
                 window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'setAccuracy', accuracy: accuracy, score: score, total: selectedQuizQuestions.length }));
             } catch (error) { console.error("Error sending accuracy:", error); }
        }

        function renderSummary() { /* ... (use selectedQuizQuestions) ... */
            let summaryHTML = `<div class="text-left p-1">
                                <h2 class="text-xl font-semibold mb-3 text-cyan-400 text-center">Quiz Summary</h2>`;
             selectedQuizQuestions.forEach((q, qIndex) => {
                const userAnswer = userAnswers[qIndex];
                const correctAnswer = q.answer;
                const isCorrect = userAnswer === correctAnswer;
                summaryHTML += `
                    <div class="summary-item bg-input-bg/70 p-3 my-3 rounded-lg border-l-4 ${isCorrect ? 'border-emerald-500' : 'border-rose-500'} text-sm">
                        <p class="font-medium mb-2">${qIndex + 1}. ${q.question}</p>
                        <p class="${isCorrect ? 'text-emerald-400' : 'text-rose-400'}"> Your: ${userAnswer !== undefined ? q.options[userAnswer] : 'Not answered'} ${isCorrect ? ' (Correct)' : ''} </p>
                        ${!isCorrect && userAnswer !== undefined ? `<p class="text-emerald-400"> Correct: ${q.options[correctAnswer]}</p>` : ''}
                         <details class="text-xs mt-2 text-gray-400 cursor-pointer">
                             <summary class="outline-none focus:ring-1 focus:ring-cyan-500 rounded px-1 inline-block">Explanation</summary>
                             <p class="mt-1">${q.summary}</p>
                         </details>
                    </div>`;
             });
            summaryHTML += `</div>`;
            return summaryHTML;
        }

        function completeQuiz() { /* ... (same as before) ... */
            try {
                window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'gameOver' }));
            } catch (error) { console.error("Error sending gameOver:", error); }
            completeBtn.textContent = "Finished"; completeBtn.disabled = true; prevBtn.disabled = true;
        }

        // --- Initial Setup ---
        nextBtn.addEventListener('click', nextStep);
        prevBtn.addEventListener('click', prevStep);
        completeBtn.addEventListener('click', completeQuiz);

        window.onload = () => {
            // Set initial total steps (will be updated before quiz starts)
            totalJourneySteps = fixedStepsCount + NUM_QUIZ_QUESTIONS;
            renderStep(0); // Render Intro step first
        };

    </script>

</body>
</html>