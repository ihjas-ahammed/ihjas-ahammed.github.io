<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Electronics Journey - MC Dungeons Theme</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font for Minecraft Style -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Custom base styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Standard font for readability */
            /* Dark purple/gray gradient inspired by the image */
             background-color: #211e2b; /* Fallback */
             background-image: linear-gradient(to bottom right, #312d3b, #211e2b);
             color: #e0e0e0; /* Light gray text default */
        }

        /* Minecraft-style font for titles/headers */
        .font-minecraft {
             font-family: 'Press Start 2P', cursive;
        }

        /* Main container mimicking the item description panel */
        .mc-container {
            background-color: rgba(33, 30, 43, 0.85); /* Slightly transparent dark background */
            backdrop-filter: blur(4px);
             border: 1px solid #5a4a6a; /* Subtle purple border */
             border-radius: 4px; /* Less rounded corners */
             box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        /* Title style */
        h1.mc-title {
            color: #ffffff;
            border-bottom: 1px solid #5a4a6a; /* Purple separator */
            padding-bottom: 0.75rem; /* Spacing */
        }

        /* Step transitions (Keep existing logic) */
        .step {
             transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
             position: absolute; width: 100%; left: 0; top: 0;
             padding: 1rem; box-sizing: border-box;
        }
        .step.hidden { opacity: 0; transform: translateX(100%); pointer-events: none; height: 0; overflow: hidden; position: absolute; }
        .step.prev-step { transform: translateX(-100%); position: absolute; }
        .step.current-step { opacity: 1; transform: translateX(0); position: relative; height: auto; overflow: visible; }

        /* Styling for code blocks and interactive elements */
        code {
            background-color: #4a4458; /* Darker purple-gray */
            padding: 2px 6px;
            border-radius: 2px; /* Sharper corners */
            font-family: 'Courier New', Courier, monospace;
            color: #ffd700; /* Gold/yellow like sparks */
            font-size: 0.9em;
            border: 1px solid #5a4a6a;
        }

        .mc-interactive-section {
            background-color: rgba(20, 18, 26, 0.7); /* Even darker inner background */
            padding: 15px;
            border-radius: 3px;
            margin-top: 20px;
             border: 1px dashed #8a4ca8; /* Dashed purple border */
        }
        .mc-interactive-section label {
            display: block; margin-bottom: 5px; font-weight: bold;
            color: #c084fc; /* Purple accent for labels */
            font-size: 0.9em;
        }
        .mc-interactive-section input[type="text"],
        .mc-interactive-section input[type="number"] {
            width: 100%; padding: 8px; margin-bottom: 10px;
            border: 1px solid #5a4a6a; /* Purple border */
            border-radius: 2px; /* Sharper corners */
            background-color: #312d3b; /* Dark input background */
            color: #e0e0e0; /* Light text */
            font-size: 0.95em;
        }
        .mc-interactive-section button, .mc-nav-button {
            background-color: #581c87; /* Dark Purple */
             color: #ffffff;
             border: 1px solid #7e22ce; /* Brighter purple border */
             padding: 8px 14px; border-radius: 2px; /* Sharper corners */
             cursor: pointer; font-size: 0.9em; font-weight: bold;
             margin-right: 8px; margin-bottom: 8px; text-transform: uppercase; /* MC buttons often uppercase */
             transition: background-color 0.2s ease, border-color 0.2s ease;
             box-shadow: 0 2px 3px rgba(0,0,0,0.3);
        }
        .mc-interactive-section button:hover, .mc-nav-button:hover {
             background-color: #6b21a8; /* Slightly lighter purple */
             border-color: #9333ea;
        }
         .mc-nav-button:disabled { /* Style for disabled nav buttons */
            background-color: #4a4458;
            border-color: #5a4a6a;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
         }

        .mc-interactive-output {
            margin-top: 10px; padding: 10px;
            background-color: #1e1b24; /* Very dark */
            border-radius: 2px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold; word-wrap: break-word; min-height: 30px;
            border: 1px solid #8a4ca8; /* Purple border */
             color: #e0e0e0; /* Light text */
        }
        .mc-interactive-output .label { color: #c084fc; font-weight: normal; font-family: inherit; }
        .error-message { color: #f87171; /* Red-400 for errors */ font-size: 0.85em; margin-top: -5px; margin-bottom: 10px; }
        .signal-diagram { /* Style the diagrams */
            width: 80%; max-width: 200px; height: auto; display: block; margin: 15px auto;
             background: #312d3b; border-radius: 3px; padding: 5px; border: 1px solid #5a4a6a;
        }
         .signal-diagram path, .signal-diagram polyline { stroke: #ffd700; /* Gold spark color */ }
         .signal-diagram line, .signal-diagram text { stroke: #9ca3af; fill: #9ca3af; /* Gray */ }

        /* Table styles */
         table { width: 100%; border-collapse: collapse; margin-bottom: 15px; background-color: #312d3b; font-size: 0.9em; border: 1px solid #5a4a6a; }
         th, td { border: 1px solid #5a4a6a; padding: 6px; text-align: center; }
         th { background-color: #4a4458; color: #c084fc; font-weight: bold; }
         td { color: #e0e0e0; }

        /* Quiz Option Styles - Inspired by Enchantment Slots */
        .option-btn {
            background-color: #312d3b; /* Dark background */
            border: 1px solid #5a4a6a;
            color: #e0e0e0;
            padding: 10px; margin: 8px 0; border-radius: 3px; cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            position: relative; /* For potential pseudo-element glows */
            text-align: left;
        }
         .option-btn:hover {
            background-color: #4a4458;
            border-color: #8a4ca8; /* Purple border on hover */
         }
        .option-btn.selected {
            background-color: #4a4458;
            border-color: #c084fc; /* Bright purple border */
            color: #ffffff;
            /* box-shadow: 0 0 5px #c084fc; Simple glow */
        }
        /* Correct/Incorrect styles */
        .option-btn.correct {
            background-color: #1e463b !important; /* Dark Green */
            border-color: #10b981 !important; /* Emerald-500 */
            color: #ffffff !important;
        }
        .option-btn.incorrect {
            background-color: #5c202d !important; /* Dark Red */
            border-color: #f43f5e !important; /* Rose-500 */
            color: #ffffff !important;
            text-decoration: line-through;
            text-decoration-color: #fda4af;
        }
        .option-btn.highlight-correct {
            border: 2px solid #10b981; /* For showing correct on summary */
        }
        /* Quiz Question Text */
        .question-block .question {
             color: #ffffff;
             font-weight: bold;
        }
        /* Step Headers */
        .step h2, .step h3 {
             font-family: 'Press Start 2P', cursive;
             color: #c084fc; /* Purple */
             margin-bottom: 0.75rem;
             font-size: 1rem; /* Adjust size for pixel font */
             letter-spacing: 1px;
        }
        .step h3 { font-size: 0.9rem; color: #ab6ff0; margin-top: 1rem;}

        /* Progress Dots - Square like pixels? Or colored circles */
        .progress-dots span {
             height: 10px; width: 10px; background-color: #4a4458; /* Default gray */
             border-radius: 1px; /* Square-ish */
             display: inline-block; margin: 0 3px; transition: background-color 0.3s ease;
             border: 1px solid #5a4a6a;
        }
        .progress-dots span.active { background-color: #c084fc; border-color: #e9d5ff; } /* Active Purple */
        .progress-dots span.completed { background-color: #10b981; border-color: #6ee7b7; } /* Completed Green */
        /* Specific step types if needed */
        .progress-dots span.learning 
        .progress-dots span.quiz 

        /* Summary Item Style */
        .summary-item {
            background-color: rgba(20, 18, 26, 0.8);
            padding: 10px; margin: 10px 0; border-radius: 3px;
            border-left-width: 5px;
            font-size: 0.9em;
        }
        .summary-item.correct { border-left-color: #10b981; /* Green */ }
        .summary-item.incorrect { border-left-color: #f43f5e; /* Red */ }
        .summary-item p { margin-bottom: 4px; }
        .summary-item .font-medium { color: #ffffff; }
        .summary-item .text-emerald-400 { color: #34d399; } /* Use specific colors */
        .summary-item .text-rose-400 { color: #fb7185; }
        .summary-item details { color: #a1a1aa; /* Gray-400 */ }
        .summary-item summary { cursor: pointer; font-weight: bold; }
        .summary-item details p { color: #d4d4d8; margin-top: 5px; } /* Lighter gray for explanation */

        /* Final Result Area */
         #final-result { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #5a4a6a; }
         #result-text { font-size: 1.1em; font-weight: bold; color: #ffffff; margin-bottom: 1rem; }
         #complete-btn {
             background-color: #059669; /* Emerald-600 */
             border-color: #10b981;
         }
          #complete-btn:hover { background-color: #047857; border-color: #34d399; }
          #complete-btn:disabled {
            background-color: #4a4458;
            border-color: #5a4a6a;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
          }

          /* Adjustments for small screens */
          @media (max-width: 640px) {
            h1.mc-title { font-size: 1rem; }
            .step h2, .step h3 { font-size: 0.9rem; }
            .step h3 { font-size: 0.8rem; }
            .mc-interactive-section button, .mc-nav-button { font-size: 0.8em; padding: 6px 10px; }
            .progress-dots span { height: 8px; width: 8px; }
          }

    </style>
    <script>
        tailwind.config = 

        // --- Mock ReactNativeWebView (Keep for testing) ---
        if (typeof window.ReactNativeWebView === 'undefined') {
            console.log("Mocking ReactNativeWebView for browser testing.");
            window.ReactNativeWebView = { postMessage: (message) => console.log("ReactNativeWebView.postMessage:", message) };
        }
        // --- End Mock ---
    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-1">

    <!-- Changed container class -->
    <div class="mc-container p-4 w-full max-w-lg overflow-hidden min-h-[550px] relative flex flex-col">

        <!-- Changed title class -->
        <h1 class="mc-title font-minecraft text-lg sm:text-xl text-center mb-3 flex-shrink-0">Digital Electronics Journey</h1>

        <!-- Progress Indicator -->
         <div id="progress-indicator" class="progress-dots text-center my-3 flex-shrink-0">
             <!-- Dots will be added here -->
         </div>

        <!-- Step Container - Takes remaining space -->
        <div id="step-container" class="relative flex-grow overflow-y-auto mb-3 pr-2"> <!-- Added padding-right for scrollbar -->
            <!-- Steps will be dynamically inserted here -->
        </div>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons mt-auto text-center border-t border-purple-700/50 pt-3 flex-shrink-0">
            <!-- Added mc-nav-button class -->
            <button id="prev-btn" class="mc-nav-button bg-gray-600 hover:bg-gray-700 border-gray-500 hover:border-gray-600 hidden">Previous</button>
            <button id="next-btn" class="mc-nav-button disabled:opacity-70 disabled:cursor-not-allowed">Start Journey</button>
        </div>

        <!-- Final Result Area (Initially Hidden) -->
         <div id="final-result" class="text-center mt-4 hidden flex-shrink-0">
            <p id="result-text" class="text-base font-semibold mb-3"></p>
            <!-- Added mc-nav-button class -->
            <button id="complete-btn" class="mc-nav-button">Finish Journey</button>
        </div>

    </div>

    <script>
        // --- Constants ---
        const NUM_QUIZ_QUESTIONS = 10;

        // --- Question Pool (40 Questions) ---
        const fullQuestionPool = [
            // ... (Keep the full question pool as it was) ...
             // Analog vs Digital
            { question: "Which signal type is less reliable due to infinite possible values?", options: ["Digital", "Binary", "Analog", "Square Wave"], answer: 2, summary: "Analog signals are susceptible to noise, which can alter their infinitely variable values, making them less reliable for precise operations compared to the two distinct states of digital signals." },
            { question: "A square wave is an example of which type of signal?", options: ["Analog", "Sinusoidal", "Digital", "Continuous"], answer: 2, summary: "Square waves have distinct high and low levels, representing the two states (1 and 0) of a digital or binary signal." },
            { question: "Driving a transistor between cut-off and saturation results in:", options: ["Amplification", "Two-state operation", "Linear output", "Oscillation"], answer: 1, summary: "In digital circuits, transistors act like switches, being either fully OFF (cut-off) or fully ON (saturation), representing the two binary states." },
            { question: "Why are digital circuits generally considered more reliable than analog circuits?", options: ["They are faster", "They use less power", "They handle discrete values", "They are cheaper"], answer: 2, summary: "Digital circuits operate with defined HIGH and LOW states, making them more immune to noise and variations compared to analog circuits processing continuous values." },
            { question: "A signal representing temperature that changes smoothly over time is:", options: ["Digital", "Binary", "Analog", "Encoded"], answer: 2, summary: "Physical quantities like temperature typically vary continuously, making their direct representation an analog signal." },
            // Binary Basics
            { question: "What is the term for a single binary digit (0 or 1)?", options: ["Byte", "Nibble", "Word", "Bit"], answer: 3, summary: "The fundamental unit of binary information is a 'bit'." },
            { question: "How many bits are in a nibble?", options: ["2", "4", "8", "16"], answer: 1, summary: "A nibble is defined as a group of 4 bits." },
            { question: "A byte consists of how many bits?", options: ["4", "8", "12", "16"], answer: 1, summary: "A standard byte is composed of 8 bits." },
            { question: "In the binary number 10110, which is the Most Significant Bit (MSB)?", options: ["The leftmost 1", "The rightmost 0", "The middle 1", "The 0 next to MSB"], answer: 0, summary: "The MSB is the bit with the highest place value, which is always the leftmost bit in standard notation." },
            { question: "What is the base or radix of the binary number system?", options: ["10", "8", "16", "2"], answer: 3, summary: "The binary system uses two digits (0 and 1), so its base (radix) is 2." },
            // Binary Counting & Conversions
            { question: "What is the binary representation of the decimal number 5?", options: ["100", "110", "101", "011"], answer: 2, summary: "Decimal 5 = (1 * 2^2) + (0 * 2^1) + (1 * 2^0) = 4 + 0 + 1 = 5. Binary is 101." },
            { question: "What is the decimal equivalent of the binary number 1101?", options: ["11", "13", "14", "9"], answer: 1, summary: "1101₂ = (1 * 2³) + (1 * 2²) + (0 * 2¹) + (1 * 2⁰) = 8 + 4 + 0 + 1 = 13₁₀." },
            { question: "Convert decimal 10 to binary.", options: ["1000", "1010", "1100", "1001"], answer: 1, summary: "Using double-dabble: 10/2=5 R 0; 5/2=2 R 1; 2/2=1 R 0; 1/2=0 R 1. Read remainders reverse: 1010₂." },
            { question: "What is the value of the binary number 0111 in decimal?", options: ["6", "7", "8", "15"], answer: 1, summary: "0111₂ = (0*8) + (1*4) + (1*2) + (1*1) = 4 + 2 + 1 = 7₁₀." },
            { question: "The binary number 10000 represents which decimal value?", options: ["8", "10", "16", "32"], answer: 2, summary: "10000₂ is 1 multiplied by 2 to the power of 4 (1 * 2⁴), which equals 16₁₀." },
             // Octal System
            { question: "What is the radix of the octal number system?", options: ["2", "16", "10", "8"], answer: 3, summary: "The octal system uses 8 digits (0-7), hence its base (radix) is 8." },
            { question: "Convert the octal number 23₈ to decimal.", options: ["19", "23", "11", "31"], answer: 0, summary: "23₈ = (2 * 8¹) + (3 * 8⁰) = 16 + 3 = 19₁₀." },
            { question: "What is the octal equivalent of the decimal number 10?", options: ["10", "12", "8", "A"], answer: 1, summary: "Divide by 8: 10 / 8 = 1 R 2. Read remainders reverse: 12₈." },
            { question: "How many binary bits are needed to represent one octal digit?", options: ["2", "3", "4", "8"], answer: 1, summary: "Since 2³ = 8, each octal digit (0-7) can be uniquely represented by a group of 3 binary bits (000-111)." },
            { question: "Convert the binary number 110 101₂ directly to octal.", options: ["65", "56", "35", "153"], answer: 0, summary: "Group binary digits in threes from right: 110 = 6, 101 = 5. Result: 65₈." },
             // Hexadecimal System
            { question: "Which base does the hexadecimal system use?", options: ["2", "8", "10", "16"], answer: 3, summary: "Hexadecimal is a base-16 system." },
            { question: "What decimal value does the hexadecimal digit 'C' represent?", options: ["10", "11", "12", "13"], answer: 2, summary: "In hexadecimal, A=10, B=11, C=12, D=13, E=14, F=15." },
            { question: "Convert the hexadecimal number 1A₁₆ to decimal.", options: ["10", "16", "26", "36"], answer: 2, summary: "1A₁₆ = (1 * 16¹) + (10 * 16⁰) = 16 + 10 = 26₁₀." },
            { question: "How many binary bits correspond to one hexadecimal digit?", options: ["2", "3", "4", "8"], answer: 2, summary: "Since 2⁴ = 16, each hexadecimal digit (0-F) can be represented by exactly 4 binary bits (0000-1111)." },
            { question: "Convert the binary number 1111 0010₂ directly to hexadecimal.", options: ["F2", "E2", "152", "2E"], answer: 0, summary: "Group binary digits in fours from right: 1111 = F, 0010 = 2. Result: F2₁₆." },
             // BCD Code
            { question: "What does BCD stand for?", options: ["Binary Coded Digit", "Binary Coded Decimal", "Base Coded Decimal", "Bit Coded Digit"], answer: 1, summary: "BCD stands for Binary Coded Decimal." },
            { question: "How is the decimal number 25 represented in BCD?", options: ["11001", "0010 0101", "100101", "19"], answer: 1, summary: "In BCD, each decimal digit is converted to its 4-bit binary equivalent: 2 -> 0010, 5 -> 0101. Result: 0010 0101." },
            { question: "What is the decimal value of the BCD code 1001 0110?", options: ["150", "96", "Invalid BCD", "1A6"], answer: 1, summary: "Convert each 4-bit group to its decimal digit: 1001 -> 9, 0110 -> 6. Result: 96₁₀." },
            { question: "Which 4-bit binary pattern is invalid in standard BCD?", options: ["1001", "0110", "1010", "0011"], answer: 2, summary: "BCD only represents decimal digits 0-9. 1010 represents decimal 10, which is not a single decimal digit, making it invalid in standard BCD." },
            { question: "Why is BCD used in some digital systems?", options: ["It's faster than binary", "It uses fewer bits", "Easy interface with decimal displays/inputs", "More efficient storage"], answer: 2, summary: "BCD makes it easier to convert to and from decimal representations, often used for displays (like 7-segment displays) and financial calculations." },
             // Inter-conversions & Mixed
            { question: "Convert (75)₈ to binary.", options: ["111101", "11101", "111 101", "101111"], answer: 2, summary: "Convert each octal digit to 3 bits: 7 -> 111, 5 -> 101. Combine them: 111 101₂." },
            { question: "Convert (3B)₁₆ to binary.", options: ["0011 1011", "111011", "1110110", "0111011"], answer: 0, summary: "Convert each hex digit to 4 bits: 3 -> 0011, B (11) -> 1011. Combine: 0011 1011₂." },
            { question: "What is the octal equivalent of (11010110)₂?", options: ["654", "326", "156", "D6"], answer: 1, summary: "Group binary in threes from right: (011)(010)(110). Convert groups: 011=3, 010=2, 110=6. Result: 326₈." },
            { question: "What is the hexadecimal equivalent of (101101110)₂?", options: ["556", "16E", "B70", "2DE"], answer: 1, summary: "Group binary in fours from right: (0001)(0110)(1110). Convert groups: 0001=1, 0110=6, 1110=E. Result: 16E₁₆." },
            { question: "Convert (52)₁₀ to hexadecimal.", options: ["34", "A4", "52", "2A"], answer: 0, summary: "Divide by 16: 52 / 16 = 3 R 4. Read remainders reverse: 34₁₆." },
            { question: "Which number system is most convenient for representing raw binary data in a more compact, human-readable form?", options: ["Decimal", "BCD", "Octal", "Hexadecimal"], answer: 3, summary: "Hexadecimal is widely used because it maps neatly to 4-bit binary groups (bytes are 8 bits), making long binary strings much shorter and easier to read/write." },
            { question: "Convert (401)₁₀ to BCD.", options: ["100 000 001", "0100 0000 0001", "110010001", "Invalid"], answer: 1, summary: "Convert each decimal digit: 4->0100, 0->0000, 1->0001. Result: 0100 0000 0001." },
            { question: "The number (1111 1010 0110)₂ is equivalent to which hexadecimal number?", options: ["F96", "EAG", "FA6", "7A6"], answer: 2, summary: "Group in fours: (1111)(1010)(0110). Convert: F A 6. Result: FA6₁₆." },
            { question: "Convert (75)₈ to hexadecimal." , options: ["3D", "75", "35", "F3"], answer: 0, summary: "Oct->Bin->Hex: 75₈ = (111 101)₂. Regroup: (0011 1101)₂ = 3D₁₆."}, // Fixed this question from original code
            { question: "Represent (100)₁₀ in binary, octal, and hexadecimal.", options: ["1100100, 144, 64", "1100100, 64, 144", "1100010, 144, 64", "1100100, 144, 64"], answer: 0, summary: "100₁₀ = 64+32+4 = 1100100₂. Group for oct: (1)(100)(100) -> 144₈. Group for hex: (0110)(0100) -> 64₁₆." },
        ];

        // --- State Variables ---
        let currentStep = 0;
        let selectedQuizQuestions = [];
        let userAnswers = [];
        let quizCompleted = false;
        let totalJourneySteps = 0; // Will be calculated later

        const fixedStepsCount = 6; // Intro + Learn x3 + Quiz Intro + Summary

        // --- DOM Elements ---
        const stepContainer = document.getElementById('step-container');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const finalResultDiv = document.getElementById('final-result');
        const resultText = document.getElementById('result-text');
        const completeBtn = document.getElementById('complete-btn');
        const progressIndicator = document.getElementById('progress-indicator');

        // --- Utility Functions (Keep existing functions) ---
        function displayOutput(elementId, label, value, isError = false) {
            const outputElement = document.getElementById(elementId);
            if (outputElement) {
                let content = `<span class="label">${label}:</span> `;
                if (isError) {
                    content += `<span class="text-red-400">${value}</span>`; // Adjusted error color
                } else {
                    content += value; // Value might contain HTML (like <br> or <sub>)
                }
                 outputElement.innerHTML = content;
            }
        }
        function displayError(elementId, message) {
             const errorElement = document.getElementById(elementId);
             if (errorElement) {
                 errorElement.textContent = message;
                 errorElement.classList.remove('hidden'); // Show error message
             }
        }
        function clearError(elementId) {
             const errorElement = document.getElementById(elementId);
             if (errorElement) {
                 errorElement.textContent = '';
                  errorElement.classList.add('hidden'); // Hide error message
             }
        }
        function isValidBinary(bin) { return /^[01]+$/.test(bin); }
        function isValidOctal(oct) { return /^[0-7]+$/.test(oct); }
        function isValidHex(hex) { return /^[0-9A-Fa-f]+$/.test(hex); }
        function isValidBcdInput(bcdStr) {
             const groups = bcdStr.trim().split(/\s+/);
             if (groups.length === 0 || groups[0] === '') return false;
             for (const group of groups) {
                 if (!/^[01]{4}$/.test(group)) return false;
                  // Stricter check for valid BCD digits (0000-1001)
                  if (parseInt(group, 2) > 9) return false;
             }
             return true;
        }
        const hexToBinMap = { '0': '0000', '1': '0001', '2': '0010', '3': '0011', '4': '0100', '5': '0101', '6': '0110', '7': '0111', '8': '1000', '9': '1001', 'A': '1010', 'B': '1011', 'C': '1100', 'D': '1101', 'E': '1110', 'F': '1111' };
        const binToHexMap = { '0000': '0', '0001': '1', '0010': '2', '0011': '3', '0100': '4', '0101': '5', '0110': '6', '0111': '7', '1000': '8', '1001': '9', '1010': 'A', '1011': 'B', '1100': 'C', '1101': 'D', '1110': 'E', '1111': 'F' };
        const decToBcdMap = { '0': '0000', '1': '0001', '2': '0010', '3': '0011', '4': '0100', '5': '0101', '6': '0110', '7': '0111', '8': '1000', '9': '1001' };
        const bcdToDecMap = { '0000':'0', '0001':'1', '0010':'2', '0011':'3', '0100':'4', '0101':'5', '0110':'6', '0111':'7', '1000':'8', '1001':'9' };

        // --- Interactive Conversion Functions (Keep existing functions) ---
        function showPlaceValue() {
            const binInput = document.getElementById('binPlaceValueInput').value.trim();
            const outputElement = document.getElementById('binPlaceValueOutput');
            clearError('binPlaceValueError');

            if (!binInput) { outputElement.textContent = ''; return; }
            if (!isValidBinary(binInput)) {
                 displayError('binPlaceValueError', 'Invalid binary input.');
                 outputElement.textContent = ''; return;
             }

            let explanation = ''; let decimalValue = 0; const len = binInput.length;
            explanation += `<code>${binInput}</code><sub class="text-xs opacity-80">2</sub> = `; // Style subscript
            let terms = [];
            for (let i = 0; i < len; i++) {
                const bit = parseInt(binInput[i]); const power = len - 1 - i;
                const placeValue = Math.pow(2, power); decimalValue += bit * placeValue;
                terms.push(`(${bit} × 2<sup>${power}</sup>)`); // Use times symbol
            }
            explanation += terms.join(' + ');
            explanation += `<br>= ${decimalValue}<sub class="text-xs opacity-80">10</sub>`;
            outputElement.innerHTML = explanation;
        }
        // --- Add ALL other conversion functions here (convertToBinary, etc.) ---
        // (Functions are the same, no need to repeat them all here for brevity)
        function convertToBinary() {
            const decInput = document.getElementById('decToBinInput').value;
            const outputId = 'decToBinOutput';
            const errorId = 'decToBinError';
            clearError(errorId);
            if (decInput === '' || isNaN(decInput) || decInput < 0 || !Number.isInteger(Number(decInput))) {
                displayError(errorId, 'Please enter a non-negative integer.');
                 displayOutput(outputId, 'Binary', '', true); return;
            }
            const decimal = parseInt(decInput, 10); const binary = decimal.toString(2);
             displayOutput(outputId, 'Binary', `<code>${binary}</code><sub class="text-xs opacity-80">2</sub>`);
        }
        function convertToDecimal() {
            const binInput = document.getElementById('binToDecInput').value.trim();
            const outputId = 'binToDecOutput'; const errorId = 'binToDecError'; clearError(errorId);
            if (!binInput) { displayOutput(outputId, 'Decimal', ''); return; }
            if (!isValidBinary(binInput)) {
                displayError(errorId, 'Invalid binary input (only 0s and 1s).');
                displayOutput(outputId, 'Decimal', '', true); return;
            }
            const decimal = parseInt(binInput, 2);
            displayOutput(outputId, 'Decimal', `${decimal}<sub class="text-xs opacity-80">10</sub>`);
        }
        function convertToOctal() {
            const decInput = document.getElementById('decToOctInput').value;
            const outputId = 'decToOctOutput'; const errorId = 'decToOctError'; clearError(errorId);
            if (decInput === '' || isNaN(decInput) || decInput < 0 || !Number.isInteger(Number(decInput))) {
                 displayError(errorId, 'Please enter a non-negative integer.');
                 displayOutput(outputId, 'Octal', '', true); return;
            }
            const decimal = parseInt(decInput, 10); const octal = decimal.toString(8);
            displayOutput(outputId, 'Octal', `<code>${octal}</code><sub class="text-xs opacity-80">8</sub>`);
        }
        function convertOctToDecimal() {
             const octInput = document.getElementById('octToDecInput').value.trim();
             const outputId = 'octToDecOutput'; const errorId = 'octToDecError'; clearError(errorId);
             if (!octInput) { displayOutput(outputId, 'Decimal', ''); return; }
             if (!isValidOctal(octInput)) {
                 displayError(errorId, 'Invalid octal input (only digits 0-7).');
                 displayOutput(outputId, 'Decimal', '', true); return;
             }
            const decimal = parseInt(octInput, 8);
            displayOutput(outputId, 'Decimal', `${decimal}<sub class="text-xs opacity-80">10</sub>`);
        }
        function convertOctToBinary() {
             const octInput = document.getElementById('octToBinInput').value.trim();
             const outputId = 'octToBinOutput'; const errorId = 'octToBinError'; clearError(errorId);
             if (!octInput) { displayOutput(outputId, 'Binary', ''); return; }
             if (!isValidOctal(octInput)) {
                 displayError(errorId, 'Invalid octal input (only digits 0-7).');
                 displayOutput(outputId, 'Binary', '', true); return;
             }
             let binary = '';
             for (let i = 0; i < octInput.length; i++) {
                 // Ensure 3 bits per digit, handle leading zeros correctly if needed (though less critical for display)
                 let binDigit = parseInt(octInput[i], 8).toString(2);
                 while (binDigit.length < 3 && i > 0) { // Don't pad the very first digit unnecessarily unless it's 0
                    binDigit = '0' + binDigit;
                 }
                 // More robust padding for display consistency:
                 if (octInput.length > 1) { // Pad if more than one oct digit
                      binary += parseInt(octInput[i], 8).toString(2).padStart(3, '0') + ' ';
                 } else {
                      binary += parseInt(octInput[i], 8).toString(2) + ' '; // Don't pad single digit
                 }
             }
            // Final refinement - ensure first group isn't padded if unnecessary
            binary = binary.trim();
            let parts = binary.split(' ');
            if (parts.length > 0) parts[0] = parseInt(parts[0],2).toString(2); // Remove leading zero from first group if any
            binary = parts.join(' ');

            displayOutput(outputId, 'Binary', `<code>${binary.trim()}</code><sub class="text-xs opacity-80">2</sub>`);
        }
         function convertBinToOctal() {
            let binInput = document.getElementById('binToOctInput').value.trim().replace(/\s+/g, '');
             const outputId = 'binToOctOutput'; const errorId = 'binToOctError'; clearError(errorId);
             if (!binInput) { displayOutput(outputId, 'Octal', ''); return; }
             if (!isValidBinary(binInput)) {
                 displayError(errorId, 'Invalid binary input.');
                 displayOutput(outputId, 'Octal', '', true); return;
             }
             // Pad START of string
             const remainder = binInput.length % 3; if (remainder !== 0) binInput = '0'.repeat(3 - remainder) + binInput;
             let octal = '';
             for (let i = 0; i < binInput.length; i += 3) { octal += parseInt(binInput.substring(i, i + 3), 2).toString(8); }
             displayOutput(outputId, 'Octal', `<code>${octal}</code><sub class="text-xs opacity-80">8</sub>`);
         }
        function convertToHex() {
            const decInput = document.getElementById('decToHexInput').value;
            const outputId = 'decToHexOutput'; const errorId = 'decToHexError'; clearError(errorId);
             if (decInput === '' || isNaN(decInput) || decInput < 0 || !Number.isInteger(Number(decInput))) {
                 displayError(errorId, 'Please enter a non-negative integer.');
                 displayOutput(outputId, 'Hex', '', true); return;
             }
            const decimal = parseInt(decInput, 10); const hex = decimal.toString(16).toUpperCase();
            displayOutput(outputId, 'Hex', `<code>${hex}</code><sub class="text-xs opacity-80">16</sub>`);
        }
        function convertHexToDecimal() {
             const hexInput = document.getElementById('hexToDecInput').value.trim();
             const outputId = 'hexToDecOutput'; const errorId = 'hexToDecError'; clearError(errorId);
              if (!hexInput) { displayOutput(outputId, 'Decimal', ''); return; }
             if (!isValidHex(hexInput)) {
                 displayError(errorId, 'Invalid hex input (0-9, A-F).');
                 displayOutput(outputId, 'Decimal', '', true); return;
             }
            const decimal = parseInt(hexInput, 16);
            displayOutput(outputId, 'Decimal', `${decimal}<sub class="text-xs opacity-80">10</sub>`);
        }
        function convertHexToBinary() {
            const hexInput = document.getElementById('hexToBinInput').value.trim().toUpperCase();
             const outputId = 'hexToBinOutput'; const errorId = 'hexToBinError'; clearError(errorId);
             if (!hexInput) { displayOutput(outputId, 'Binary', ''); return; }
             if (!isValidHex(hexInput)) {
                 displayError(errorId, 'Invalid hex input (0-9, A-F).');
                 displayOutput(outputId, 'Binary', '', true); return;
             }
             let binary = '';
             for (let i = 0; i < hexInput.length; i++) { binary += hexToBinMap[hexInput[i]] + ' '; }
            displayOutput(outputId, 'Binary', `<code>${binary.trim()}</code><sub class="text-xs opacity-80">2</sub>`);
        }
         function convertBinToHex() {
            let binInput = document.getElementById('binToHexInput').value.trim().replace(/\s+/g, '');
             const outputId = 'binToHexOutput'; const errorId = 'binToHexError'; clearError(errorId);
             if (!binInput) { displayOutput(outputId, 'Hex', ''); return; }
             if (!isValidBinary(binInput)) {
                 displayError(errorId, 'Invalid binary input.');
                 displayOutput(outputId, 'Hex', '', true); return;
             }
              // Pad START of string
             const remainder = binInput.length % 4; if (remainder !== 0) binInput = '0'.repeat(4 - remainder) + binInput;
             let hex = '';
             for (let i = 0; i < binInput.length; i += 4) { hex += binToHexMap[binInput.substring(i, i + 4)]; }
             displayOutput(outputId, 'Hex', `<code>${hex}</code><sub class="text-xs opacity-80">16</sub>`);
         }
        function convertToBcd() {
            const decInput = document.getElementById('decToBcdInput').value;
            const outputId = 'decToBcdOutput'; const errorId = 'decToBcdError'; clearError(errorId);
             if (decInput === '' || isNaN(decInput) || decInput < 0 || !Number.isInteger(Number(decInput))) {
                 displayError(errorId, 'Please enter a non-negative integer.');
                 displayOutput(outputId, 'BCD', '', true); return;
             }
            let bcd = ''; const decString = decInput.toString();
            for (let i = 0; i < decString.length; i++) { bcd += decToBcdMap[decString[i]] + ' '; }
            displayOutput(outputId, 'BCD', `<code>${bcd.trim()}</code>`);
        }
        function convertBcdToDecimal() {
            const bcdInput = document.getElementById('bcdToDecInput').value.trim();
            const outputId = 'bcdToDecOutput'; const errorId = 'bcdToDecError'; clearError(errorId);
             if (!bcdInput) { displayOutput(outputId, 'Decimal', ''); return; }
             if (!isValidBcdInput(bcdInput)) {
                  displayError(errorId, 'Invalid BCD format/value. Use 4-bit groups (0000-1001) separated by spaces.');
                  displayOutput(outputId, 'Decimal', '', true); return;
             }
             const groups = bcdInput.split(/\s+/); let decimal = '';
             for (const group of groups) { decimal += bcdToDecMap[group]; }
             displayOutput(outputId, 'Decimal', `${decimal}<sub class="text-xs opacity-80">10</sub>`);
        }


        // --- Journey Logic (Keep existing functions) ---
        function shuffleArray(array) { // Fisher-Yates Shuffle
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        function selectRandomQuestions() {
            selectedQuizQuestions = shuffleArray([...fullQuestionPool]).slice(0, NUM_QUIZ_QUESTIONS);
            userAnswers = new Array(NUM_QUIZ_QUESTIONS).fill(undefined);
            totalJourneySteps = fixedStepsCount + NUM_QUIZ_QUESTIONS;
            quizCompleted = false;
        }
        function renderProgressDots() {
            progressIndicator.innerHTML = '';
            for (let i = 0; i < totalJourneySteps; i++) {
                 const dot = document.createElement('span');
                 if (i === currentStep) {
                     dot.classList.add('active');
                 } else if (i < currentStep || (quizCompleted && i < totalJourneySteps - 1) ) {
                      dot.classList.add('completed');
                 }
                 // Add type class for potential future styling (optional now)
                 // if (i >= 1 && i <= 3) dot.classList.add('learning');
                 // else if (i > 4 && i <= 4 + NUM_QUIZ_QUESTIONS) dot.classList.add('quiz');
                 progressIndicator.appendChild(dot);
            }
        }

        function renderStep(stepIndex) {
            // --- Step Rendering Logic (Minor Adjustments for Theme Classes) ---
            stepContainer.querySelectorAll('.step').forEach(step => {
                 step.classList.remove('current-step', 'prev-step');
                 step.classList.add('hidden');
            });

            let currentStepElement = stepContainer.querySelector(`#step-${stepIndex}`);
            const isNewStep = !currentStepElement;

            if (isNewStep) {
                currentStepElement = document.createElement('div');
                currentStepElement.id = `step-${stepIndex}`;
                currentStepElement.classList.add('step');
                let stepContent = '';

                // --- Define Content for Each Step (Add Theme Classes) ---
                switch (stepIndex) {
                    case 0: // Intro
                        stepContent = `
                            <div class="text-center">
                                <h2 class="text-xl mb-4">Welcome, Adventurer!</h2>
                                <p class="mb-3 text-gray-300">Embark on a journey through the fundamentals of Digital Electronics.</p>
                                <p class="mb-5">You'll explore key concepts and test your knowledge with a ${NUM_QUIZ_QUESTIONS}-question trial.</p>
                                <p class="text-sm text-gray-400">Use the navigation buttons below to proceed.</p>
                            </div>`;
                        break;
                    case 1: // Analog vs Binary
                         stepContent = `
                            <h2>1. Ancient Signals vs. Digital Power</h2>
                            <h3>Analog Whispers</h3>
                            <ul class="list-disc ml-6 mb-3 text-sm space-y-1 text-gray-300">
                                <li>Continuously varying energy.</li>
                                <li>Can hold infinite values within its range.</li>
                                <li>Like a flowing river, susceptible to ripples (noise).</li>
                            </ul>
                            <svg viewBox="0 0 100 50" class="signal-diagram" aria-label="Sine wave diagram">
                              <path d="M 0 25 Q 12.5 0, 25 25 T 50 25 T 75 25 T 100 25" stroke-width="1.5"/>
                              <line x1="0" y1="25" x2="100" y2="25" stroke-dasharray="2,2"/>
                            </svg>
                            <p class="text-sm mb-4 text-gray-400">Transistors handling these signals amplify continuously, but noise can easily corrupt the message.</p>

                            <h3>Binary Runes</h3>
                             <ul class="list-disc ml-6 mb-3 text-sm space-y-1 text-gray-300">
                                <li>Only two distinct states: High/Low, Charged/Empty, <code>1</code>/<code>0</code>.</li>
                                <li>Like a switch, either ON or OFF.</li>
                            </ul>
                             <svg viewBox="0 0 100 50" class="signal-diagram" aria-label="Square wave diagram">
                               <polyline points="0,40 20,40 20,10 40,10 40,40 60,40 60,10 80,10 80,40 100,40" stroke-width="1.5"/>
                               <text x="5" y="38" font-size="7px">Low (0)</text> <text x="25" y="8" font-size="7px">High (1)</text>
                            </svg>
                            <p class="text-sm mb-4 text-gray-400">Digital signals command transistors to be fully ON or OFF, providing robust, clear states.</p>

                            <h3>Digital Circuits</h3>
                            <p class="text-sm mb-3 text-gray-300">Forged pathways designed specifically to channel and manipulate these powerful two-state signals.</p>
                        `;
                        break;
                    case 2: // Binary System
                        stepContent = `
                            <h2>2. The Binary Code</h2>
                            <p class="text-sm mb-3 text-gray-300">The language of machines, using only two symbols: <code>0</code> and <code>1</code>. Base = 2.</p>
                            <h3>Counting Ritual</h3>
                            <table><thead><tr><th>Decimal</th><th>Binary</th></tr></thead>
                            <tbody>
                                <tr><td>0</td><td>0</td></tr><tr><td>1</td><td>1</td></tr>
                                <tr><td>2</td><td>10</td></tr><tr><td>3</td><td>11</td></tr>
                                <tr><td>4</td><td>100</td></tr><tr><td>5</td><td>101</td></tr>
                                <tr><td>...</td><td>...</td></tr>
                            </tbody></table>

                            <h3>Sacred Terms</h3>
                            <ul class="list-disc ml-6 mb-4 text-sm space-y-1 text-gray-300">
                                <li><strong>Bit:</strong> A single binary rune (<code>0</code> or <code>1</code>).</li>
                                <li><strong>Nibble:</strong> A quartet of bits (4 bits).</li>
                                <li><strong>Byte:</strong> An octet of bits (8 bits).</li>
                            </ul>

                            <h3>Positional Power</h3>
                            <p class="text-sm mb-2 text-gray-300">Each position holds a power of 2.</p>
                            <p class="text-xs mb-1 text-gray-400">Example: <code>1011</code><sub class="opacity-80">2</sub> = (1 × 2<sup>3</sup>) + (0 × 2<sup>2</sup>) + (1 × 2<sup>1</sup>) + (1 × 2<sup>0</sup>)</p>
                            <p class="text-xs mb-3 text-gray-400">= 8 + 0 + 2 + 1 = 11<sub class="opacity-80">10</sub></p>
                            <ul class="list-disc ml-6 mb-3 text-xs space-y-1 text-gray-400">
                                <li>MSB (Most Significant Bit): Leftmost, greatest power.</li>
                                <li>LSB (Least Significant Bit): Rightmost, least power.</li>
                            </ul>

                             <div class="mc-interactive-section"> <!-- Themed section -->
                                <h4 class="font-minecraft text-purple-400 text-sm mb-3">Decipher Place Value</h4>
                                <label for="binPlaceValueInput">Enter Binary:</label>
                                <input type="text" id="binPlaceValueInput" placeholder="e.g., 1101">
                                <div id="binPlaceValueError" class="error-message hidden"></div>
                                <button onclick="showPlaceValue()">Calculate</button> <!-- Themed button -->
                                <div id="binPlaceValueOutput" class="mc-interactive-output"></div> <!-- Themed output -->
                             </div>
                        `;
                         break;
                    case 3: // Conversions (Oct, Hex, BCD) - Apply Theme Classes
                         stepContent = `
                             <h2>3. Number System Glyphs</h2>

                             <!-- Octal -->
                             <h3>Octal Runes (Base 8)</h3>
                             <p class="text-sm mb-2 text-gray-300">Uses digits 0-7. Easily transmuted from binary (3 bits per rune).</p>
                             <div class="mc-interactive-section mb-4">
                                <h4 class="font-minecraft text-purple-400 text-sm mb-3">Octal Transmuter</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4"> <!-- Layout for inputs -->
                                    <div>
                                        <label for="decToOctInput">Dec to Oct:</label> <input type="number" id="decToOctInput" placeholder="Decimal">
                                        <div id="decToOctError" class="error-message hidden"></div> <button onclick="convertToOctal()">Convert</button>
                                        <div id="decToOctOutput" class="mc-interactive-output mb-2"></div>
                                    </div>
                                    <div>
                                        <label for="octToDecInput">Oct to Dec:</label> <input type="text" id="octToDecInput" placeholder="Octal (0-7)">
                                        <div id="octToDecError" class="error-message hidden"></div> <button onclick="convertOctToDecimal()">Convert</button>
                                        <div id="octToDecOutput" class="mc-interactive-output mb-2"></div>
                                    </div>
                                     <div>
                                        <label for="octToBinInput">Oct to Bin:</label> <input type="text" id="octToBinInput" placeholder="Octal (0-7)">
                                        <div id="octToBinError" class="error-message hidden"></div> <button onclick="convertOctToBinary()">Convert</button>
                                        <div id="octToBinOutput" class="mc-interactive-output mb-2"></div>
                                     </div>
                                     <div>
                                        <label for="binToOctInput">Bin to Oct:</label> <input type="text" id="binToOctInput" placeholder="Binary (group by 3)">
                                        <div id="binToOctError" class="error-message hidden"></div> <button onclick="convertBinToOctal()">Convert</button>
                                        <div id="binToOctOutput" class="mc-interactive-output"></div>
                                     </div>
                                </div>
                             </div>

                             <!-- Hexadecimal -->
                             <h3>Hexadecimal Glyphs (Base 16)</h3>
                             <p class="text-sm mb-2 text-gray-300">Uses 0-9 and A-F (A=10...F=15). Maps cleanly to 4 binary bits.</p>
                             <table class="mb-3"><thead><tr><th>Dec</th><th>Hex</th><th>Bin</th></tr></thead><tbody><tr><td>10</td><td>A</td><td>1010</td></tr><tr><td>11</td><td>B</td><td>1011</td></tr><tr><td>...</td><td>...</td><td>...</td></tr><tr><td>15</td><td>F</td><td>1111</td></tr></tbody></table>
                              <div class="mc-interactive-section mb-4">
                                 <h4 class="font-minecraft text-purple-400 text-sm mb-3">Hexadecimal Scribe</h4>
                                  <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4">
                                     <div>
                                         <label for="decToHexInput">Dec to Hex:</label> <input type="number" id="decToHexInput" placeholder="Decimal">
                                         <div id="decToHexError" class="error-message hidden"></div> <button onclick="convertToHex()">Convert</button>
                                         <div id="decToHexOutput" class="mc-interactive-output mb-2"></div>
                                     </div>
                                     <div>
                                         <label for="hexToDecInput">Hex to Dec:</label> <input type="text" id="hexToDecInput" placeholder="Hex (0-9, A-F)">
                                         <div id="hexToDecError" class="error-message hidden"></div> <button onclick="convertHexToDecimal()">Convert</button>
                                         <div id="hexToDecOutput" class="mc-interactive-output mb-2"></div>
                                     </div>
                                     <div>
                                         <label for="hexToBinInput">Hex to Bin:</label> <input type="text" id="hexToBinInput" placeholder="Hex (0-9, A-F)">
                                         <div id="hexToBinError" class="error-message hidden"></div> <button onclick="convertHexToBinary()">Convert</button>
                                         <div id="hexToBinOutput" class="mc-interactive-output mb-2"></div>
                                     </div>
                                      <div>
                                         <label for="binToHexInput">Bin to Hex:</label> <input type="text" id="binToHexInput" placeholder="Binary (group by 4)">
                                         <div id="binToHexError" class="error-message hidden"></div> <button onclick="convertBinToHex()">Convert</button>
                                         <div id="binToHexOutput" class="mc-interactive-output"></div>
                                      </div>
                                  </div>
                              </div>

                             <!-- BCD -->
                             <h3>BCD Tablets (Binary Coded Decimal)</h3>
                             <p class="text-sm mb-2 text-gray-300">Encodes each decimal digit (0-9) with its 4-bit binary form. Bridges decimal and binary worlds.</p>
                             <p class="text-xs mb-2 text-gray-400">Example: <code>289</code><sub class="opacity-80">10</sub> = <code>0010 1000 1001</code> (BCD)</p>
                             <div class="mc-interactive-section">
                                 <h4 class="font-minecraft text-purple-400 text-sm mb-3">BCD Decoder</h4>
                                  <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4">
                                     <div>
                                         <label for="decToBcdInput">Dec to BCD:</label> <input type="number" id="decToBcdInput" placeholder="Decimal (0-9 digits)">
                                         <div id="decToBcdError" class="error-message hidden"></div> <button onclick="convertToBcd()">Convert</button>
                                         <div id="decToBcdOutput" class="mc-interactive-output mb-2"></div>
                                     </div>
                                      <div>
                                         <label for="bcdToDecInput">BCD to Dec:</label> <input type="text" id="bcdToDecInput" placeholder="BCD (4-bit groups, space separated)">
                                         <div id="bcdToDecError" class="error-message hidden"></div> <button onclick="convertBcdToDecimal()">Convert</button>
                                         <div id="bcdToDecOutput" class="mc-interactive-output"></div>
                                      </div>
                                  </div>
                             </div>
                         `;
                         break;
                    case 4: // Quiz Intro
                        stepContent = `
                            <div class="text-center">
                                <h2 class="text-xl mb-4">The Trial Begins!</h2>
                                <p class="mb-5 text-gray-300">Prove your mastery. Answer ${NUM_QUIZ_QUESTIONS} questions drawn from the digital ether.</p>
                                <p class="text-sm text-gray-400">Choose wisely and proceed.</p>
                            </div>`;
                        break;
                    // --- Quiz Questions and Summary (Theme Classes applied dynamically) ---
                    default:
                         if (stepIndex > 4 && stepIndex <= 4 + NUM_QUIZ_QUESTIONS) { // Quiz Question Step
                            const qIndex = stepIndex - (4 + 1);
                            if (qIndex < selectedQuizQuestions.length) {
                                const q = selectedQuizQuestions[qIndex];
                                let optionsHTML = '';
                                q.options.forEach((opt, optIndex) => {
                                    const isSelected = userAnswers[qIndex] === optIndex;
                                    // Added theme class 'option-btn'
                                    optionsHTML += `
                                        <div class="option-btn ${isSelected ? 'selected' : ''}"
                                             data-q-index="${qIndex}" data-opt-index="${optIndex}">
                                            ${opt}
                                        </div>
                                    `;
                                });
                                stepContent = `
                                    <div class="question-block p-1">
                                        <div class="question mb-5 text-base">Trial ${qIndex + 1}/${NUM_QUIZ_QUESTIONS}: ${q.question}</div>
                                        <div class="options">${optionsHTML}</div>
                                    </div>
                                `;
                            } else { stepContent = `<p class="text-red-400">Error: Question index out of bounds.</p>`; }

                        } else if (stepIndex === totalJourneySteps - 1) { // Summary Step
                             stepContent = renderSummary(); // Uses themed classes inside
                        } else {
                             stepContent = `<p>Step ${stepIndex} content not defined.</p>`;
                        }
                        break;
                }

                currentStepElement.innerHTML = stepContent;
                stepContainer.appendChild(currentStepElement);

                // Re-add event listeners if needed (same logic)
                if (stepIndex > 4 && stepIndex <= 4 + NUM_QUIZ_QUESTIONS) {
                    currentStepElement.querySelectorAll('.option-btn').forEach(btn => {
                        btn.addEventListener('click', handleOptionClick);
                    });
                }
            }

             // Manage visibility and transitions (same logic)
            const previousStepIndex = parseInt(stepContainer.dataset.previousStep || '-1');
             if (stepIndex > previousStepIndex) {
                 const prevStepElement = stepContainer.querySelector(`#step-${previousStepIndex}`);
                 if (prevStepElement) prevStepElement.classList.add('prev-step');
                 currentStepElement.classList.remove('hidden', 'prev-step');
                 currentStepElement.classList.add('current-step');
             } else {
                 const prevStepElement = stepContainer.querySelector(`#step-${previousStepIndex}`);
                 if (prevStepElement) prevStepElement.classList.remove('prev-step');
                 // Adjust for immediate visibility on 'prev'
                 currentStepElement.style.transform = 'translateX(-100%)';
                 currentStepElement.classList.remove('hidden'); // Make visible *before* transition starts
                 requestAnimationFrame(() => { // Allow repaint
                     currentStepElement.classList.add('current-step'); // Add class to trigger transition
                     currentStepElement.style.transform = 'translateX(0)'; // Set target state
                 });
             }

            stepContainer.dataset.previousStep = stepIndex;
            stepContainer.scrollTop = 0;

            updateButtonStates();
            renderProgressDots();
        }

        function updateButtonStates() {
            prevBtn.classList.toggle('hidden', currentStep === 0);
            nextBtn.classList.remove('hidden');
            finalResultDiv.classList.add('hidden'); // Always hide final initially

            // Update text and disabled state based on current step
            if (currentStep === 0) { nextBtn.textContent = 'Start Journey'; nextBtn.disabled = false; }
            else if (currentStep < 4) { nextBtn.textContent = 'Next Section'; nextBtn.disabled = false; }
            else if (currentStep === 4) { nextBtn.textContent = 'Start Trial'; nextBtn.disabled = false; }
            else if (currentStep > 4 && currentStep <= 4 + NUM_QUIZ_QUESTIONS) {
                const qIndex = currentStep - (4 + 1);
                nextBtn.disabled = userAnswers[qIndex] === undefined;
                 if (currentStep === 4 + NUM_QUIZ_QUESTIONS) { nextBtn.textContent = 'View Results'; }
                 else { nextBtn.textContent = 'Next Question'; }
            } else if (currentStep === totalJourneySteps - 1) { // Summary step
                nextBtn.classList.add('hidden'); // Hide Next on summary
                prevBtn.classList.remove('hidden'); // Ensure Prev is visible
                finalResultDiv.classList.remove('hidden'); // Show final area
                calculateAndDisplayResults();
            }
        }

        function handleOptionClick(event) {
             if (quizCompleted) return; // Don't allow changes after quiz is done (summary view)
             const selectedBtn = event.target.closest('.option-btn');
             if (!selectedBtn) return; // Click wasn't on an option button

             const qIndex = parseInt(selectedBtn.dataset.qIndex);
             const optIndex = parseInt(selectedBtn.dataset.optIndex);

             // If we are on the summary step, don't allow selection changes
             if (currentStep === totalJourneySteps - 1) return;

             userAnswers[qIndex] = optIndex;

             const optionsInQuestion = stepContainer.querySelectorAll(`.option-btn[data-q-index="${qIndex}"]`);
             optionsInQuestion.forEach(btn => btn.classList.remove('selected')); // Use theme's selected class
             selectedBtn.classList.add('selected');

             nextBtn.disabled = false; // Enable Next button
         }

        function nextStep() {
            if (currentStep === 4) {
                selectRandomQuestions();
                renderProgressDots(); // Update dots immediately after selection
            }
             if (currentStep < totalJourneySteps - 1) {
                 if (currentStep === 4 + NUM_QUIZ_QUESTIONS) { // Moving TO summary
                      quizCompleted = true; // Mark quiz as completed
                      // Optional: Disable prev button if you don't want them going back into quiz questions from summary
                      // prevBtn.disabled = true;
                 }
                currentStep++;
                renderStep(currentStep);
            }
        }

        function prevStep() {
             // Prevent going back into the quiz once summary is reached? Optional.
             // if (quizCompleted && currentStep === totalJourneySteps - 1) return;

             if (currentStep > 0) {
                // If moving back from summary, re-enable quiz interactions?
                // if (currentStep === totalJourneySteps - 1) quizCompleted = false; // Allow re-answering?

                currentStep--;
                renderStep(currentStep);
            }
        }

        function calculateAndDisplayResults() {
             let score = 0;
             userAnswers.forEach((answer, index) => {
                 if (selectedQuizQuestions[index] && answer === selectedQuizQuestions[index].answer) {
                     score++;
                 }
             });
             const accuracy = selectedQuizQuestions.length > 0 ? Math.round((score / selectedQuizQuestions.length) * 100) : 0;
             resultText.textContent = `Trial Complete! Score: ${score} / ${selectedQuizQuestions.length} (${accuracy}%)`; // Themed text
             try {
                 window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'setAccuracy', accuracy: (accuracy/100), score: score, total: selectedQuizQuestions.length }));
             } catch (error) { console.error("Error sending accuracy:", error); }
        }

        function renderSummary() {
            let summaryHTML = `<div class="text-left p-1">
                                <h2 class="text-xl text-center mb-4">Trial Results</h2>`; // Themed Header
             selectedQuizQuestions.forEach((q, qIndex) => {
                const userAnswer = userAnswers[qIndex];
                const correctAnswer = q.answer;
                const isCorrect = userAnswer === correctAnswer;
                // Added theme classes 'summary-item' and 'correct'/'incorrect'
                summaryHTML += `
                    <div class="summary-item ${isCorrect ? 'correct' : 'incorrect'}">
                        <p class="font-medium mb-2 text-gray-200">${qIndex + 1}. ${q.question}</p>
                        <p class="${isCorrect ? 'text-emerald-400' : 'text-rose-400'}"> Your Answer: ${userAnswer !== undefined ? q.options[userAnswer] : 'Not answered'} ${isCorrect ? '<span class="text-green-400 font-bold">(Correct)</span>' : ''} </p>
                        ${!isCorrect && userAnswer !== undefined ? `<p class="text-emerald-400"> Correct Answer: ${q.options[correctAnswer]}</p>` : ''}
                        ${!isCorrect && userAnswer === undefined ? `<p class="text-emerald-400"> Correct Answer: ${q.options[correctAnswer]}</p>` : ''}
                         <details class="text-xs mt-2 cursor-pointer">
                             <summary class="font-bold outline-none focus:ring-1 focus:ring-purple-500 rounded px-1 inline-block text-gray-400 hover:text-gray-200">Explanation</summary>
                             <p class="mt-1 text-gray-300">${q.summary}</p>
                         </details>
                    </div>`;
             });
            summaryHTML += `</div>`;
            return summaryHTML;
        }


        function completeQuiz() {
            try {
                window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'gameOver' }));
            } catch (error) { console.error("Error sending gameOver:", error); }
            completeBtn.textContent = "Finished";
            completeBtn.disabled = true;
            prevBtn.disabled = true; // Disable prev on final completion
             nextBtn.disabled = true; // Disable next as well
        }

        // --- Initial Setup ---
        nextBtn.addEventListener('click', nextStep);
        prevBtn.addEventListener('click', prevStep);
        completeBtn.addEventListener('click', completeQuiz);

        window.onload = () => {
            totalJourneySteps = fixedStepsCount + NUM_QUIZ_QUESTIONS; // Initial calc
            renderStep(0); // Render Intro step
        };

    </script>

</body>
</html>